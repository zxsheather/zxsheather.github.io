<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="zh-CN" >
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  ><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Pintos 线程系统详解（八）：锁" />
<meta property="og:locale" content="zh_CN" />
<meta name="description" content="详细解析 Pintos 中锁（Lock）的实现，理解互斥机制。" />
<meta property="og:description" content="详细解析 Pintos 中锁（Lock）的实现，理解互斥机制。" />
<link rel="canonical" href="http://localhost:4000/posts/pintos-thread-08-lock/" />
<meta property="og:url" content="http://localhost:4000/posts/pintos-thread-08-lock/" />
<meta property="og:site_name" content="Zxsheather" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2026-01-26T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Pintos 线程系统详解（八）：锁" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2026-01-26T00:00:00+08:00","datePublished":"2026-01-26T00:00:00+08:00","description":"详细解析 Pintos 中锁（Lock）的实现，理解互斥机制。","headline":"Pintos 线程系统详解（八）：锁","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/pintos-thread-08-lock/"},"url":"http://localhost:4000/posts/pintos-thread-08-lock/"}</script>
<!-- End Jekyll SEO tag -->


  <title>Pintos 线程系统详解（八）：锁 | Zxsheather
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="icon" type="image/png" href="/assets/img/favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/svg+xml" href="/assets/img/favicons/favicon.svg">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">

  <link rel="manifest" href="/assets/img/favicons/site.webmanifest">



  <!-- Resource Hints -->
  
    
      
        <link rel="preconnect" href="https://fonts.googleapis.com" >
      
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
      
    
      
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" >
      
    
      
        <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      
        <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
      
    
  

  <!-- Bootstrap -->
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
  

  <!-- Theme style -->
  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  <!-- Web Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css">

  <!-- 3rd-party Dependencies -->

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.36.4/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Image Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css">
  

  <!-- Scripts -->

  <script src="/assets/js/dist/theme.min.js"></script>

  <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.18/dayjs.min.js,npm/dayjs@1.11.18/locale/zh.js,npm/dayjs@1.11.18/plugin/relativeTime.js,npm/dayjs@1.11.18/plugin/localizedFormat.js,npm/tocbot@4.36.4/dist/tocbot.min.js,npm/mermaid@11.12.0/dist/mermaid.min.js"></script>







<script defer src="/assets/js/dist/post.min.js"></script>



<!-- Pageviews -->

  

  



  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/3.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <a class="site-title d-block" href="/">Zxsheather</a>
    <p class="site-subtitle fst-italic mb-0">A CS Undergraduate</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>首页</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>分类</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>标签</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>归档</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>关于</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    
      <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle">
        <i class="fas fa-adjust"></i>
      </button>

      
    

    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">首页</a>
            </span>

          
        
          
        
          
            
              <span>Pintos 线程系统详解（八）：锁</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      文章
    </div>

    <button type="button" id="search-trigger" class="btn btn-link" aria-label="Search">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search id="search" class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="搜索..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">取消</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->





<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->










<article class="px-1" data-toc="true">
  <header>
    <h1 data-toc-skip>Pintos 线程系统详解（八）：锁</h1>
    
      <p class="post-desc fw-light mb-4">详细解析 Pintos 中锁（Lock）的实现，理解互斥机制。</p>
    

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        发表于
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1769356800"
  data-df="YYYY/MM/DD"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  2026/01/26
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          作者

          <em>
            
              <a href="https://github.com/zxsheather">Zxsheather</a>
            
          </em>
        </span>

        <div>
          <!-- pageviews -->
          

          <!-- read time -->
          <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="2870 字"
>
  <em>15 分钟</em>阅读</span>

        </div>
      </div>
    </div>
  </header>

  
    <div id="toc-bar" class="d-flex align-items-center justify-content-between invisible">
      <span class="label text-truncate">Pintos 线程系统详解（八）：锁</span>
      <button type="button" class="toc-trigger btn me-1">
        <i class="fa-solid fa-list-ul fa-fw"></i>
      </button>
    </div>

    <button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm">
      <span class="label ps-2 pe-1">文章内容</span>
      <i class="fa-solid fa-angle-right fa-fw"></i>
    </button>

    <dialog id="toc-popup" class="p-0">
      <div class="header d-flex flex-row align-items-center justify-content-between">
        <div class="label text-truncate py-2 ms-4">Pintos 线程系统详解（八）：锁</div>
        <button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75">
          <i class="fas fa-close"></i>
        </button>
      </div>
      <div id="toc-popup-content" class="px-4 py-3 pb-4"></div>
    </dialog>
  

  <div class="content">
    <h2 id="概述"><span class="me-2">概述</span><a href="#概述" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>本文档详细解析 Pintos 中<strong>锁（Lock）</strong>的实现。锁是最常用的同步原语，用于实现<strong>互斥</strong>（Mutual Exclusion），确保同一时刻只有一个线程能访问共享资源。</p>

<p>在 Pintos 中，锁是基于<strong>信号量</strong>实现的。</p>

<hr />

<h2 id="原始代码"><span class="me-2">原始代码</span><a href="#原始代码" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="synchh-中的定义"><span class="me-2">synch.h 中的定义</span><a href="#synchh-中的定义" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="cm">/** Lock. */</span>
<span class="k">struct</span> <span class="n">lock</span> 
  <span class="p">{</span>
    <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">holder</span><span class="p">;</span>      <span class="cm">/**&lt; Thread holding lock (for debugging). */</span>
    <span class="k">struct</span> <span class="n">semaphore</span> <span class="n">semaphore</span><span class="p">;</span> <span class="cm">/**&lt; Binary semaphore controlling access. */</span>
  <span class="p">};</span>

<span class="kt">void</span> <span class="nf">lock_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">lock_acquire</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="p">);</span>
<span class="n">bool</span> <span class="nf">lock_try_acquire</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">lock_release</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="p">);</span>
<span class="n">bool</span> <span class="nf">lock_held_by_current_thread</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="synchc-中的实现"><span class="me-2">synch.c 中的实现</span><a href="#synchc-中的实现" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
</pre></td><td class="rouge-code"><pre><span class="cm">/** Initializes LOCK.  A lock can be held by at most a single
   thread at any given time.  Our locks are not "recursive", that
   is, it is an error for the thread currently holding a lock to
   try to acquire that lock.

   A lock is a specialization of a semaphore with an initial
   value of 1.  The difference between a lock and such a
   semaphore is twofold.  First, a semaphore can have a value
   greater than 1, but a lock can only be owned by a single
   thread at a time.  Second, a semaphore does not have an owner,
   meaning that one thread can "down" the semaphore and then
   another one "up" it, but with a lock the same thread must both
   acquire and release it.  When these restrictions prove
   onerous, it's a good sign that a semaphore should be used,
   instead of a lock. */</span>
<span class="kt">void</span>
<span class="nf">lock_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">lock</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="n">lock</span><span class="o">-&gt;</span><span class="n">holder</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">sema_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">semaphore</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/** Acquires LOCK, sleeping until it becomes available if
   necessary.  The lock must not already be held by the current
   thread.

   This function may sleep, so it must not be called within an
   interrupt handler.  This function may be called with
   interrupts disabled, but interrupts will be turned back on if
   we need to sleep. */</span>
<span class="kt">void</span>
<span class="nf">lock_acquire</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">lock</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="o">!</span><span class="n">intr_context</span> <span class="p">());</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="o">!</span><span class="n">lock_held_by_current_thread</span> <span class="p">(</span><span class="n">lock</span><span class="p">));</span>

  <span class="n">sema_down</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">semaphore</span><span class="p">);</span>
  <span class="n">lock</span><span class="o">-&gt;</span><span class="n">holder</span> <span class="o">=</span> <span class="n">thread_current</span> <span class="p">();</span>
<span class="p">}</span>

<span class="cm">/** Tries to acquires LOCK and returns true if successful or false
   on failure.  The lock must not already be held by the current
   thread.

   This function will not sleep, so it may be called within an
   interrupt handler. */</span>
<span class="n">bool</span>
<span class="nf">lock_try_acquire</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">bool</span> <span class="n">success</span><span class="p">;</span>

  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">lock</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="o">!</span><span class="n">lock_held_by_current_thread</span> <span class="p">(</span><span class="n">lock</span><span class="p">));</span>

  <span class="n">success</span> <span class="o">=</span> <span class="n">sema_try_down</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">semaphore</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span>
    <span class="n">lock</span><span class="o">-&gt;</span><span class="n">holder</span> <span class="o">=</span> <span class="n">thread_current</span> <span class="p">();</span>
  <span class="k">return</span> <span class="n">success</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Releases LOCK, which must be owned by the current thread.

   An interrupt handler cannot acquire a lock, so it does not
   make sense to try to release a lock within an interrupt
   handler. */</span>
<span class="kt">void</span>
<span class="nf">lock_release</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">lock</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">lock_held_by_current_thread</span> <span class="p">(</span><span class="n">lock</span><span class="p">));</span>

  <span class="n">lock</span><span class="o">-&gt;</span><span class="n">holder</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">sema_up</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">semaphore</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/** Returns true if the current thread holds LOCK, false
   otherwise.  (Note that testing whether some other thread holds
   a lock would be racy.) */</span>
<span class="n">bool</span>
<span class="nf">lock_held_by_current_thread</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">lock</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">holder</span> <span class="o">==</span> <span class="n">thread_current</span> <span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="前置知识"><span class="me-2">前置知识</span><a href="#前置知识" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="1-锁-vs-信号量"><span class="me-2">1. 锁 vs 信号量</span><a href="#1-锁-vs-信号量" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th>特性</th>
      <th>锁（Lock）</th>
      <th>信号量（Semaphore）</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>值的范围</td>
      <td>0 或 1</td>
      <td>任意非负整数</td>
    </tr>
    <tr>
      <td>所有者</td>
      <td>有（holder）</td>
      <td>无</td>
    </tr>
    <tr>
      <td>释放约束</td>
      <td>只有持有者可释放</td>
      <td>任何线程可 up</td>
    </tr>
    <tr>
      <td>递归支持</td>
      <td>Pintos 不支持</td>
      <td>不适用</td>
    </tr>
    <tr>
      <td>主要用途</td>
      <td>互斥</td>
      <td>资源计数、同步</td>
    </tr>
  </tbody>
</table></div>

<h3 id="2-互斥的概念"><span class="me-2">2. 互斥的概念</span><a href="#2-互斥的概念" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>临界区（Critical Section）</strong>：访问共享资源的代码段。</p>

<p><strong>互斥</strong>：确保同一时刻只有一个线程在临界区内。</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="c1">// 没有互斥 - 危险！</span>
<span class="n">shared_counter</span><span class="o">++</span><span class="p">;</span>  <span class="c1">// 多线程同时执行会出错</span>

<span class="c1">// 有互斥 - 安全</span>
<span class="n">lock_acquire</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">counter_lock</span><span class="p">);</span>
<span class="n">shared_counter</span><span class="o">++</span><span class="p">;</span>  <span class="c1">// 只有一个线程能执行</span>
<span class="n">lock_release</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">counter_lock</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="3-为什么锁需要所有者"><span class="me-2">3. 为什么锁需要所有者？</span><a href="#3-为什么锁需要所有者" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ol>
  <li><strong>调试</strong>：可以知道谁持有锁</li>
  <li><strong>安全</strong>：防止非持有者释放锁</li>
  <li><strong>防止递归</strong>：检测同一线程重复获取锁</li>
</ol>

<hr />

<h2 id="struct-lock-详解"><span class="me-2">struct lock 详解</span><a href="#struct-lock-详解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">lock</span> 
  <span class="p">{</span>
    <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">holder</span><span class="p">;</span>      <span class="cm">/**&lt; Thread holding lock. */</span>
    <span class="k">struct</span> <span class="n">semaphore</span> <span class="n">semaphore</span><span class="p">;</span> <span class="cm">/**&lt; Binary semaphore controlling access. */</span>
  <span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>holder</strong>：当前持有锁的线程</p>
<ul>
  <li>NULL 表示锁未被持有</li>
  <li>非 NULL 表示被某线程持有</li>
</ul>

<p><strong>semaphore</strong>：底层的二进制信号量</p>
<ul>
  <li>初始值为 1</li>
  <li>用于实现互斥</li>
</ul>

<p><strong>内存布局</strong>：</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>struct lock
┌─────────────────────────────────┐
│   holder (4 bytes)              │  指向持有者线程
├─────────────────────────────────┤
│   semaphore.value (4 bytes)     │  0 或 1
├─────────────────────────────────┤
│   semaphore.waiters (list)      │  等待队列
└─────────────────────────────────┘
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="lock_init-详解"><span class="me-2">lock_init() 详解</span><a href="#lock_init-详解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kt">void</span>
<span class="nf">lock_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">lock</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="n">lock</span><span class="o">-&gt;</span><span class="n">holder</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">sema_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">semaphore</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>初始化锁：</p>
<ol>
  <li>holder 设为 NULL（无持有者）</li>
  <li>信号量初始化为 1（锁可用）</li>
</ol>

<hr />

<h2 id="lock_acquire-详解"><span class="me-2">lock_acquire() 详解</span><a href="#lock_acquire-详解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kt">void</span>
<span class="nf">lock_acquire</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">lock</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="o">!</span><span class="n">intr_context</span> <span class="p">());</span>              <span class="c1">// 不能在中断中获取</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="o">!</span><span class="n">lock_held_by_current_thread</span> <span class="p">(</span><span class="n">lock</span><span class="p">));</span>  <span class="c1">// 不能重复获取</span>

  <span class="n">sema_down</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">semaphore</span><span class="p">);</span>           <span class="c1">// 获取信号量</span>
  <span class="n">lock</span><span class="o">-&gt;</span><span class="n">holder</span> <span class="o">=</span> <span class="n">thread_current</span> <span class="p">();</span>       <span class="c1">// 设置持有者</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="执行流程"><span class="me-2">执行流程</span><a href="#执行流程" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre>线程 A 调用 lock_acquire(&amp;lock)
         │
         ▼
    检查断言
         │
         ▼
    sema_down(&amp;lock-&gt;semaphore)
         │
         ├─── semaphore.value &gt; 0 ───► value--，立即返回
         │
         └─── semaphore.value == 0 ───► 阻塞等待
                      │
                      ▼
              (等待锁被释放)
                      │
                      ▼
              (被唤醒，value--)
         │
         ◄────────────┘
         │
         ▼
    lock-&gt;holder = thread_current()
         │
         ▼
      返回（已获取锁）
</pre></td></tr></tbody></table></code></div></div>

<h3 id="为什么不能重复获取"><span class="me-2">为什么不能重复获取？</span><a href="#为什么不能重复获取" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">ASSERT</span> <span class="p">(</span><span class="o">!</span><span class="n">lock_held_by_current_thread</span> <span class="p">(</span><span class="n">lock</span><span class="p">));</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Pintos 的锁是<strong>非递归</strong>的。如果允许重复获取：</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">func_a</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">lock_acquire</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
  <span class="n">func_b</span> <span class="p">();</span>            <span class="c1">// 调用 func_b</span>
  <span class="n">lock_release</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">func_b</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">lock_acquire</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>  <span class="c1">// 死锁！已经持有但 value=0</span>
  <span class="c1">// ...</span>
  <span class="n">lock_release</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>要解决这个问题需要<strong>递归锁</strong>，但 Pintos 不支持。</p>

<hr />

<h2 id="lock_try_acquire-详解"><span class="me-2">lock_try_acquire() 详解</span><a href="#lock_try_acquire-详解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="n">bool</span>
<span class="nf">lock_try_acquire</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">bool</span> <span class="n">success</span><span class="p">;</span>

  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">lock</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="o">!</span><span class="n">lock_held_by_current_thread</span> <span class="p">(</span><span class="n">lock</span><span class="p">));</span>

  <span class="n">success</span> <span class="o">=</span> <span class="n">sema_try_down</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">semaphore</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span>
    <span class="n">lock</span><span class="o">-&gt;</span><span class="n">holder</span> <span class="o">=</span> <span class="n">thread_current</span> <span class="p">();</span>
  <span class="k">return</span> <span class="n">success</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>特点</strong>：</p>
<ul>
  <li>非阻塞</li>
  <li>成功返回 true，失败返回 false</li>
  <li>可以在中断处理程序中调用（但通常不建议）</li>
</ul>

<p><strong>使用场景</strong>：</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="n">lock_try_acquire</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">))</span> <span class="p">{</span>
  <span class="c1">// 获取成功，使用资源</span>
  <span class="n">use_resource</span> <span class="p">();</span>
  <span class="n">lock_release</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="c1">// 获取失败，做其他事</span>
  <span class="n">handle_contention</span> <span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="lock_release-详解"><span class="me-2">lock_release() 详解</span><a href="#lock_release-详解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kt">void</span>
<span class="nf">lock_release</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">lock</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">lock_held_by_current_thread</span> <span class="p">(</span><span class="n">lock</span><span class="p">));</span>  <span class="c1">// 必须是持有者</span>

  <span class="n">lock</span><span class="o">-&gt;</span><span class="n">holder</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>              <span class="c1">// 清除持有者</span>
  <span class="n">sema_up</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">semaphore</span><span class="p">);</span>       <span class="c1">// 释放信号量</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="执行流程-1"><span class="me-2">执行流程</span><a href="#执行流程-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>线程 A 调用 lock_release(&amp;lock)
         │
         ▼
    检查是否是持有者
         │
         ▼
    lock-&gt;holder = NULL
         │
         ▼
    sema_up(&amp;lock-&gt;semaphore)
         │
         ├─── 有等待者 ───► 唤醒一个等待线程
         │
         └─── 无等待者 ───► 仅 value++
         │
         ▼
      返回
</pre></td></tr></tbody></table></code></div></div>

<h3 id="为什么只有持有者可以释放"><span class="me-2">为什么只有持有者可以释放？</span><a href="#为什么只有持有者可以释放" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">ASSERT</span> <span class="p">(</span><span class="n">lock_held_by_current_thread</span> <span class="p">(</span><span class="n">lock</span><span class="p">));</span>
</pre></td></tr></tbody></table></code></div></div>

<p>这确保了锁的<strong>语义正确性</strong>：</p>
<ul>
  <li>防止意外释放别人的锁</li>
  <li>便于调试（快速发现错误）</li>
</ul>

<hr />

<h2 id="lock_held_by_current_thread-详解"><span class="me-2">lock_held_by_current_thread() 详解</span><a href="#lock_held_by_current_thread-详解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="n">bool</span>
<span class="nf">lock_held_by_current_thread</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">lock</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">holder</span> <span class="o">==</span> <span class="n">thread_current</span> <span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>检查当前线程是否持有锁。</p>

<p><strong>为什么只能检查当前线程？</strong></p>

<blockquote>
  <p>“Note that testing whether some other thread holds a lock would be racy.”</p>
</blockquote>

<p>检查其他线程是否持有锁存在竞态条件：</p>
<ul>
  <li>你检查时，那个线程可能正在释放锁</li>
  <li>检查结果可能立即过时</li>
</ul>

<p>但检查当前线程是安全的：</p>
<ul>
  <li>如果我持有锁，只有我能释放它</li>
  <li>如果我不持有锁，我不能改变这个状态（直到我获取它）</li>
</ul>

<hr />

<h2 id="锁的状态图"><span class="me-2">锁的状态图</span><a href="#锁的状态图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre>                    lock_init()
                         │
                         ▼
              ┌─────────────────────┐
              │    holder = NULL    │
              │ semaphore.value = 1 │
              │    (锁可用)         │
              └─────────────────────┘
                         │
                         │ Thread A: lock_acquire
                         ▼
              ┌─────────────────────┐
              │    holder = A       │
              │ semaphore.value = 0 │
              │   (锁被 A 持有)     │
              └─────────────────────┘
                         │
          ┌──────────────┴──────────────┐
          │                             │
          │ Thread B: lock_acquire      │ Thread A: lock_release
          ▼                             ▼
┌─────────────────────┐      ┌─────────────────────┐
│    holder = A       │      │    holder = NULL    │
│ semaphore.value = 0 │      │ semaphore.value = 1 │
│  waiters = [B]      │      │    (锁可用)         │
│   (B 在等待)        │      └─────────────────────┘
└─────────────────────┘
          │
          │ Thread A: lock_release
          ▼
┌─────────────────────┐
│    holder = B       │  ← B 被唤醒并获取锁
│ semaphore.value = 0 │
│   (锁被 B 持有)     │
└─────────────────────┘
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="锁的使用模式"><span class="me-2">锁的使用模式</span><a href="#锁的使用模式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="1-保护共享数据"><span class="me-2">1. 保护共享数据</span><a href="#1-保护共享数据" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">shared_data</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">lock</span> <span class="n">lock</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
  <span class="c1">// ... 其他字段 ...</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">init_shared_data</span> <span class="p">(</span><span class="k">struct</span> <span class="n">shared_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">lock_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
  <span class="n">data</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">update_data</span> <span class="p">(</span><span class="k">struct</span> <span class="n">shared_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_value</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">lock_acquire</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
  <span class="n">data</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">;</span>
  <span class="n">lock_release</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">read_data</span> <span class="p">(</span><span class="k">struct</span> <span class="n">shared_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
  <span class="n">lock_acquire</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
  <span class="n">value</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
  <span class="n">lock_release</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="2-原子操作"><span class="me-2">2. 原子操作</span><a href="#2-原子操作" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">atomic_increment</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">counter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">lock_acquire</span> <span class="p">(</span><span class="n">lock</span><span class="p">);</span>
  <span class="p">(</span><span class="o">*</span><span class="n">counter</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
  <span class="n">lock_release</span> <span class="p">(</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="3-保护链表操作"><span class="me-2">3. 保护链表操作</span><a href="#3-保护链表操作" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">list</span> <span class="n">shared_list</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">lock</span> <span class="n">list_lock</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">add_to_list</span> <span class="p">(</span><span class="k">struct</span> <span class="n">list_elem</span> <span class="o">*</span><span class="n">elem</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">lock_acquire</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">list_lock</span><span class="p">);</span>
  <span class="n">list_push_back</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">shared_list</span><span class="p">,</span> <span class="n">elem</span><span class="p">);</span>
  <span class="n">lock_release</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">list_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">list_elem</span> <span class="o">*</span><span class="nf">remove_from_list</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">list_elem</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">lock_acquire</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">list_lock</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">shared_list</span><span class="p">))</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">list_pop_front</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">shared_list</span><span class="p">);</span>
  <span class="n">lock_release</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">list_lock</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">e</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="锁与信号量的对比实现"><span class="me-2">锁与信号量的对比实现</span><a href="#锁与信号量的对比实现" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="用信号量实现互斥"><span class="me-2">用信号量实现互斥</span><a href="#用信号量实现互斥" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">semaphore</span> <span class="n">mutex</span><span class="p">;</span>
<span class="n">sema_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="c1">// 临界区</span>
<span class="n">sema_down</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="c1">// ... 访问共享资源 ...</span>
<span class="n">sema_up</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="用锁实现互斥"><span class="me-2">用锁实现互斥</span><a href="#用锁实现互斥" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">lock</span> <span class="n">lock</span><span class="p">;</span>
<span class="n">lock_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>

<span class="c1">// 临界区</span>
<span class="n">lock_acquire</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<span class="c1">// ... 访问共享资源 ...</span>
<span class="n">lock_release</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>锁的优势</strong>：</p>
<ul>
  <li>有所有者概念，更安全</li>
  <li>可以检测错误使用（如非持有者释放）</li>
  <li>语义更清晰</li>
</ul>

<hr />

<h2 id="死锁"><span class="me-2">死锁</span><a href="#死锁" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="什么是死锁"><span class="me-2">什么是死锁？</span><a href="#什么是死锁" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>多个线程互相等待对方持有的锁，永远无法继续。</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c1">// Thread A                    // Thread B</span>
<span class="n">lock_acquire</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock1</span><span class="p">);</span>         <span class="n">lock_acquire</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock2</span><span class="p">);</span>
<span class="n">lock_acquire</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock2</span><span class="p">);</span>         <span class="n">lock_acquire</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock1</span><span class="p">);</span>  <span class="c1">// 死锁！</span>
<span class="c1">// ...                         // ...</span>
<span class="n">lock_release</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock2</span><span class="p">);</span>         <span class="n">lock_release</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock1</span><span class="p">);</span>
<span class="n">lock_release</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock1</span><span class="p">);</span>         <span class="n">lock_release</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock2</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>Thread A:                    Thread B:
持有 lock1                   持有 lock2
等待 lock2 ─────────────► 被 B 持有
                            等待 lock1 ─────────────► 被 A 持有
</pre></td></tr></tbody></table></code></div></div>

<h3 id="避免死锁的方法"><span class="me-2">避免死锁的方法</span><a href="#避免死锁的方法" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ol>
  <li><strong>锁顺序</strong>：总是按相同顺序获取锁
    <div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="c1">// 总是先获取 lock1，再获取 lock2</span>
<span class="n">lock_acquire</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock1</span><span class="p">);</span>
<span class="n">lock_acquire</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock2</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>尝试获取</strong>：使用 try_acquire，失败时释放已持有的锁
    <div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">lock_acquire</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">lock_try_acquire</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock2</span><span class="p">))</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="n">lock_release</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock1</span><span class="p">);</span>
  <span class="n">thread_yield</span> <span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>超时机制</strong>：Pintos 不支持，但其他系统可能有</li>
</ol>

<hr />

<h2 id="常见问题"><span class="me-2">常见问题</span><a href="#常见问题" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="q1-为什么-lock_acquire-不能在中断中调用"><span class="me-2">Q1: 为什么 lock_acquire 不能在中断中调用？</span><a href="#q1-为什么-lock_acquire-不能在中断中调用" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>答</strong>：因为它可能阻塞。中断处理程序必须快速完成，不能等待锁。</p>

<h3 id="q2-持有锁的线程退出了会怎样"><span class="me-2">Q2: 持有锁的线程退出了会怎样？</span><a href="#q2-持有锁的线程退出了会怎样" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>答</strong>：锁不会自动释放，等待的线程会永远阻塞。这是一个<strong>bug</strong>，应该确保线程退出前释放所有锁。</p>

<h3 id="q3-为什么-pintos-的锁不是递归的"><span class="me-2">Q3: 为什么 Pintos 的锁不是递归的？</span><a href="#q3-为什么-pintos-的锁不是递归的" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>答</strong>：递归锁更复杂，需要：</p>
<ul>
  <li>记录递归深度</li>
  <li>只有深度降为 0 时才真正释放</li>
</ul>

<p>Pintos 为了简单选择不支持。如果需要递归，应该重构代码避免递归获取。</p>

<h3 id="q4-lock_try_acquire-什么时候有用"><span class="me-2">Q4: lock_try_acquire 什么时候有用？</span><a href="#q4-lock_try_acquire-什么时候有用" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>答</strong>：</p>
<ul>
  <li>当不能阻塞时（如中断处理）</li>
  <li>当有替代方案时</li>
  <li>实现超时机制时</li>
</ul>

<h3 id="q5-为什么先清除-holder-再-sema_up"><span class="me-2">Q5: 为什么先清除 holder 再 sema_up？</span><a href="#q5-为什么先清除-holder-再-sema_up" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">lock</span><span class="o">-&gt;</span><span class="n">holder</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="n">sema_up</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">semaphore</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>答</strong>：顺序其实不重要，因为整个过程受禁用中断保护。但先清除 holder 更符合逻辑：”先放弃所有权，再唤醒等待者”。</p>

<hr />

<h2 id="练习思考"><span class="me-2">练习思考</span><a href="#练习思考" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<ol>
  <li>
    <p><strong>分析题</strong>：如果 lock_release 不检查是否是持有者就释放，会有什么问题？</p>
  </li>
  <li>
    <p><strong>设计题</strong>：如何实现一个递归锁（可重入锁）？</p>
  </li>
  <li>
    <p><strong>调试题</strong>：如何检测死锁？</p>
  </li>
  <li>
    <p><strong>思考题</strong>：为什么 lock_held_by_current_thread 只能检查当前线程？</p>
  </li>
  <li>
    <p><strong>扩展题</strong>：研究读写锁（rwlock）的概念，思考如何实现。</p>
  </li>
</ol>

<hr />

<h2 id="下一步"><span class="me-2">下一步</span><a href="#下一步" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>理解了锁后，下一篇文档将介绍<strong>条件变量（Condition Variable）</strong>的实现，它允许线程等待特定条件成立。</p>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/%E6%8A%80%E6%9C%AF/">技术</a>,
          <a href="/categories/pintos/">Pintos</a>
      </div>
    

    <!-- tags -->
    
      <div class="post-tags">
        <i class="fa fa-tags fa-fw me-1"></i>
        
          <a
            href="/tags/os/"
            class="post-tag no-text-decoration"
          >OS</a>
        
          <a
            href="/tags/pintos/"
            class="post-tag no-text-decoration"
          >Pintos</a>
        
          <a
            href="/tags/%E5%90%8C%E6%AD%A5/"
            class="post-tag no-text-decoration"
          >同步</a>
        
          <a
            href="/tags/%E9%94%81/"
            class="post-tag no-text-decoration"
          >锁</a>
        
          <a
            href="/tags/%E4%BA%92%E6%96%A5/"
            class="post-tag no-text-decoration"
          >互斥</a>
        
      </div>
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          本文由作者按照 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         进行授权
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">分享</span>
  <span class="share-icons">
    
    
    

    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="分享链接"
      data-title-succeed="链接已复制！"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">最近更新</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pintos-thread-03-create/">Pintos 线程系统详解（三）：线程创建</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pintos-thread-04-schedule/">Pintos 线程系统详解（四）：线程调度</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pintos-thread-05-switch/">Pintos 线程系统详解（五）：上下文切换</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pintos-thread-06-block-unblock/">Pintos 线程系统详解（六）：阻塞与唤醒</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pintos-thread-07-semaphore/">Pintos 线程系统详解（七）：信号量</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">热门标签</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/os/">OS</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/pintos/">Pintos</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E6%B1%87%E7%BC%96/">汇编</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%BC%95%E5%AF%BC%E5%8A%A0%E8%BD%BD%E7%A8%8B%E5%BA%8F/">引导加载程序</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E7%BA%BF%E7%A8%8B/">线程</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%86%85%E6%A0%B8/">内核</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%90%8C%E6%AD%A5/">同步</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/c%E8%AF%AD%E8%A8%80/">C语言</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/gdt/">GDT</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/x86/">x86</a>
      
    </div>
  </section>


            </div>

            
              
              






  <div class="toc-border-cover z-3"></div>
  <section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4">
    <h2 class="panel-heading ps-3 pb-2 mb-0">文章内容</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->















  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">相关文章</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/pintos-thread-09-condition/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1769356800"
  data-df="YYYY/MM/DD"
  
>
  2026/01/26
</time>

              <h4 class="pt-0 my-2">Pintos 线程系统详解（九）：条件变量</h4>
              <div class="text-muted">
                <p>详细解析 Pintos 中条件变量（Condition Variable）的实现，理解高级同步机制。</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/pintos-thread-07-semaphore/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1769356800"
  data-df="YYYY/MM/DD"
  
>
  2026/01/26
</time>

              <h4 class="pt-0 my-2">Pintos 线程系统详解（七）：信号量</h4>
              <div class="text-muted">
                <p>详细解析 Pintos 中信号量（Semaphore）的实现，理解这一基础同步原语。</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/pintos-thread-06-block-unblock/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1769356800"
  data-df="YYYY/MM/DD"
  
>
  2026/01/26
</time>

              <h4 class="pt-0 my-2">Pintos 线程系统详解（六）：阻塞与唤醒</h4>
              <div class="text-muted">
                <p>详细解析 Pintos 中线程的阻塞与唤醒机制，包括 thread_block() 和 thread_unblock() 函数。</p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/pintos-thread-07-semaphore/"
      class="btn btn-outline-primary"
      aria-label="上一篇"
    >
      <p>Pintos 线程系统详解（七）：信号量</p>
    </a>
  

  
    <a
      href="/posts/pintos-thread-09-condition/"
      class="btn btn-outline-primary"
      aria-label="下一篇"
    >
      <p>Pintos 线程系统详解（九）：条件变量</p>
    </a>
  
</nav>

            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>©
    <time>2026</time>

    
      <a href="https://github.com/zxsheather">Zxsheather</a>.
    

    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。"
      >保留部分权利。</span>
    
  </p>

  <p>本站采用 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 主题 <a
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="v7.4.1"
        href="https://github.com/cotes2020/jekyll-theme-chirpy"
        target="_blank"
        rel="noopener"
      >Chirpy</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center d-none">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">热门标签</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/os/">OS</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/pintos/">Pintos</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E6%B1%87%E7%BC%96/">汇编</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%BC%95%E5%AF%BC%E5%8A%A0%E8%BD%BD%E7%A8%8B%E5%BA%8F/">引导加载程序</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E7%BA%BF%E7%A8%8B/">线程</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%86%85%E6%A0%B8/">内核</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%90%8C%E6%AD%A5/">同步</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/c%E8%AF%AD%E8%A8%80/">C语言</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/gdt/">GDT</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/x86/">x86</a>
      
    </div>
  </section>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">发现新版本的内容。</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      更新
    </button>
  </div>
</aside>

    

    <!-- Embedded scripts -->

    
      
      <!-- The comments switcher -->


    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  
  document.addEventListener('DOMContentLoaded', () => {
    SimpleJekyllSearch({
      searchInput: document.getElementById('search-input'),
      resultsContainer: document.getElementById('search-results'),
      json: '/assets/js/data/search.json',
      searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{content}</p>  </article>',
      noResultsText: '<p class="mt-5">搜索结果为空</p>',
      templateMiddleware: function(prop, value, template) {
        if (prop === 'categories') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
          }
        }

        if (prop === 'tags') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
          }
        }
      }
    });
  });
</script>

  </body>
</html>

