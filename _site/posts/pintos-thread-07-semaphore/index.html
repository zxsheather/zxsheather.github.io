<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="zh-CN" >
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  ><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Pintos 线程系统详解（七）：信号量" />
<meta property="og:locale" content="zh_CN" />
<meta name="description" content="详细解析 Pintos 中信号量（Semaphore）的实现，理解这一基础同步原语。" />
<meta property="og:description" content="详细解析 Pintos 中信号量（Semaphore）的实现，理解这一基础同步原语。" />
<link rel="canonical" href="http://localhost:4000/posts/pintos-thread-07-semaphore/" />
<meta property="og:url" content="http://localhost:4000/posts/pintos-thread-07-semaphore/" />
<meta property="og:site_name" content="Zxsheather" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2026-01-26T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Pintos 线程系统详解（七）：信号量" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2026-01-26T00:00:00+08:00","datePublished":"2026-01-26T00:00:00+08:00","description":"详细解析 Pintos 中信号量（Semaphore）的实现，理解这一基础同步原语。","headline":"Pintos 线程系统详解（七）：信号量","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/pintos-thread-07-semaphore/"},"url":"http://localhost:4000/posts/pintos-thread-07-semaphore/"}</script>
<!-- End Jekyll SEO tag -->


  <title>Pintos 线程系统详解（七）：信号量 | Zxsheather
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="icon" type="image/png" href="/assets/img/favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/svg+xml" href="/assets/img/favicons/favicon.svg">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">

  <link rel="manifest" href="/assets/img/favicons/site.webmanifest">



  <!-- Resource Hints -->
  
    
      
        <link rel="preconnect" href="https://fonts.googleapis.com" >
      
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
      
    
      
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" >
      
    
      
        <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      
        <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
      
    
  

  <!-- Bootstrap -->
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
  

  <!-- Theme style -->
  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  <!-- Web Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css">

  <!-- 3rd-party Dependencies -->

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.36.4/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Image Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css">
  

  <!-- Scripts -->

  <script src="/assets/js/dist/theme.min.js"></script>

  <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.18/dayjs.min.js,npm/dayjs@1.11.18/locale/zh.js,npm/dayjs@1.11.18/plugin/relativeTime.js,npm/dayjs@1.11.18/plugin/localizedFormat.js,npm/tocbot@4.36.4/dist/tocbot.min.js,npm/mermaid@11.12.0/dist/mermaid.min.js"></script>







<script defer src="/assets/js/dist/post.min.js"></script>



<!-- Pageviews -->

  

  



  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/3.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <a class="site-title d-block" href="/">Zxsheather</a>
    <p class="site-subtitle fst-italic mb-0">A CS Undergraduate</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>首页</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>分类</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>标签</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>归档</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>关于</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    
      <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle">
        <i class="fas fa-adjust"></i>
      </button>

      
    

    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">首页</a>
            </span>

          
        
          
        
          
            
              <span>Pintos 线程系统详解（七）：信号量</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      文章
    </div>

    <button type="button" id="search-trigger" class="btn btn-link" aria-label="Search">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search id="search" class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="搜索..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">取消</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->





<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->










<article class="px-1" data-toc="true">
  <header>
    <h1 data-toc-skip>Pintos 线程系统详解（七）：信号量</h1>
    
      <p class="post-desc fw-light mb-4">详细解析 Pintos 中信号量（Semaphore）的实现，理解这一基础同步原语。</p>
    

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        发表于
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1769356800"
  data-df="YYYY/MM/DD"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  2026/01/26
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          作者

          <em>
            
              <a href="https://github.com/zxsheather">Zxsheather</a>
            
          </em>
        </span>

        <div>
          <!-- pageviews -->
          

          <!-- read time -->
          <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="2729 字"
>
  <em>15 分钟</em>阅读</span>

        </div>
      </div>
    </div>
  </header>

  
    <div id="toc-bar" class="d-flex align-items-center justify-content-between invisible">
      <span class="label text-truncate">Pintos 线程系统详解（七）：信号量</span>
      <button type="button" class="toc-trigger btn me-1">
        <i class="fa-solid fa-list-ul fa-fw"></i>
      </button>
    </div>

    <button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm">
      <span class="label ps-2 pe-1">文章内容</span>
      <i class="fa-solid fa-angle-right fa-fw"></i>
    </button>

    <dialog id="toc-popup" class="p-0">
      <div class="header d-flex flex-row align-items-center justify-content-between">
        <div class="label text-truncate py-2 ms-4">Pintos 线程系统详解（七）：信号量</div>
        <button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75">
          <i class="fas fa-close"></i>
        </button>
      </div>
      <div id="toc-popup-content" class="px-4 py-3 pb-4"></div>
    </dialog>
  

  <div class="content">
    <h2 id="概述"><span class="me-2">概述</span><a href="#概述" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>本文档详细解析 Pintos 中<strong>信号量（Semaphore）</strong>的实现。信号量是最基础的同步原语之一，可以用来实现：</p>
<ul>
  <li>互斥（Mutual Exclusion）</li>
  <li>资源计数</li>
  <li>线程间同步</li>
</ul>

<p>Pintos 中的锁和条件变量都是基于信号量实现的。</p>

<hr />

<h2 id="原始代码"><span class="me-2">原始代码</span><a href="#原始代码" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="synchh-中的定义"><span class="me-2">synch.h 中的定义</span><a href="#synchh-中的定义" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="cm">/** A counting semaphore. */</span>
<span class="k">struct</span> <span class="n">semaphore</span> 
  <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="n">value</span><span class="p">;</span>             <span class="cm">/**&lt; Current value. */</span>
    <span class="k">struct</span> <span class="n">list</span> <span class="n">waiters</span><span class="p">;</span>        <span class="cm">/**&lt; List of waiting threads. */</span>
  <span class="p">};</span>

<span class="kt">void</span> <span class="nf">sema_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">semaphore</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">value</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">sema_down</span> <span class="p">(</span><span class="k">struct</span> <span class="n">semaphore</span> <span class="o">*</span><span class="p">);</span>
<span class="n">bool</span> <span class="nf">sema_try_down</span> <span class="p">(</span><span class="k">struct</span> <span class="n">semaphore</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">sema_up</span> <span class="p">(</span><span class="k">struct</span> <span class="n">semaphore</span> <span class="o">*</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="synchc-中的实现"><span class="me-2">synch.c 中的实现</span><a href="#synchc-中的实现" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
</pre></td><td class="rouge-code"><pre><span class="cm">/** Initializes semaphore SEMA to VALUE.  A semaphore is a
   nonnegative integer along with two atomic operators for
   manipulating it:

   - down or "P": wait for the value to become positive, then
     decrement it.

   - up or "V": increment the value (and wake up one waiting
     thread, if any). */</span>
<span class="kt">void</span>
<span class="nf">sema_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">semaphore</span> <span class="o">*</span><span class="n">sema</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">value</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">sema</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="n">sema</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
  <span class="n">list_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sema</span><span class="o">-&gt;</span><span class="n">waiters</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/** Down or "P" operation on a semaphore.  Waits for SEMA's value
   to become positive and then atomically decrements it.

   This function may sleep, so it must not be called within an
   interrupt handler.  This function may be called with
   interrupts disabled, but if it sleeps then the next scheduled
   thread will probably turn interrupts back on. */</span>
<span class="kt">void</span>
<span class="nf">sema_down</span> <span class="p">(</span><span class="k">struct</span> <span class="n">semaphore</span> <span class="o">*</span><span class="n">sema</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="k">enum</span> <span class="n">intr_level</span> <span class="n">old_level</span><span class="p">;</span>

  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">sema</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="o">!</span><span class="n">intr_context</span> <span class="p">());</span>

  <span class="n">old_level</span> <span class="o">=</span> <span class="n">intr_disable</span> <span class="p">();</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">sema</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> 
    <span class="p">{</span>
      <span class="n">list_push_back</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sema</span><span class="o">-&gt;</span><span class="n">waiters</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">thread_current</span> <span class="p">()</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">);</span>
      <span class="n">thread_block</span> <span class="p">();</span>
    <span class="p">}</span>
  <span class="n">sema</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">--</span><span class="p">;</span>
  <span class="n">intr_set_level</span> <span class="p">(</span><span class="n">old_level</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/** Down or "P" operation on a semaphore, but only if the
   semaphore is not already 0.  Returns true if the semaphore is
   decremented, false otherwise.

   This function may be called from an interrupt handler. */</span>
<span class="n">bool</span>
<span class="nf">sema_try_down</span> <span class="p">(</span><span class="k">struct</span> <span class="n">semaphore</span> <span class="o">*</span><span class="n">sema</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="k">enum</span> <span class="n">intr_level</span> <span class="n">old_level</span><span class="p">;</span>
  <span class="n">bool</span> <span class="n">success</span><span class="p">;</span>

  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">sema</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="n">old_level</span> <span class="o">=</span> <span class="n">intr_disable</span> <span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">sema</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> 
    <span class="p">{</span>
      <span class="n">sema</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">--</span><span class="p">;</span>
      <span class="n">success</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> 
    <span class="p">}</span>
  <span class="k">else</span>
    <span class="n">success</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="n">intr_set_level</span> <span class="p">(</span><span class="n">old_level</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">success</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Up or "V" operation on a semaphore.  Increments SEMA's value
   and wakes up one thread of those waiting for SEMA, if any.

   This function may be called from an interrupt handler. */</span>
<span class="kt">void</span>
<span class="nf">sema_up</span> <span class="p">(</span><span class="k">struct</span> <span class="n">semaphore</span> <span class="o">*</span><span class="n">sema</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="k">enum</span> <span class="n">intr_level</span> <span class="n">old_level</span><span class="p">;</span>

  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">sema</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="n">old_level</span> <span class="o">=</span> <span class="n">intr_disable</span> <span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sema</span><span class="o">-&gt;</span><span class="n">waiters</span><span class="p">))</span> 
    <span class="n">thread_unblock</span> <span class="p">(</span><span class="n">list_entry</span> <span class="p">(</span><span class="n">list_pop_front</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sema</span><span class="o">-&gt;</span><span class="n">waiters</span><span class="p">),</span>
                                <span class="k">struct</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">elem</span><span class="p">));</span>
  <span class="n">sema</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">++</span><span class="p">;</span>
  <span class="n">intr_set_level</span> <span class="p">(</span><span class="n">old_level</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="前置知识"><span class="me-2">前置知识</span><a href="#前置知识" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="1-信号量的概念"><span class="me-2">1. 信号量的概念</span><a href="#1-信号量的概念" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>信号量</strong>是 Dijkstra 在 1965 年提出的同步原语，由两部分组成：</p>
<ul>
  <li>一个<strong>整数值</strong></li>
  <li>两个<strong>原子操作</strong>：P（等待/down）和 V（信号/up）</li>
</ul>

<p><strong>P 操作</strong>（荷兰语 Proberen，尝试）：</p>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>while (value == 0) wait;
value--;
</pre></td></tr></tbody></table></code></div></div>

<p><strong>V 操作</strong>（荷兰语 Verhogen，增加）：</p>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>value++;
if (有线程在等待) 唤醒一个;
</pre></td></tr></tbody></table></code></div></div>

<h3 id="2-信号量的用途"><span class="me-2">2. 信号量的用途</span><a href="#2-信号量的用途" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>二进制信号量（Binary Semaphore）</strong>：value 只为 0 或 1</p>
<ul>
  <li>用于互斥（类似锁）</li>
</ul>

<p><strong>计数信号量（Counting Semaphore）</strong>：value 可以是任意非负整数</p>
<ul>
  <li>用于资源计数（如限制并发数）</li>
  <li>用于生产者-消费者问题</li>
</ul>

<h3 id="3-为什么叫信号量"><span class="me-2">3. 为什么叫”信号量”？</span><a href="#3-为什么叫信号量" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>可以把它想象成停车场的空位数：</p>
<ul>
  <li>初始值 = 总停车位数</li>
  <li>进入（P）：如果有空位，占用一个；否则等待</li>
  <li>离开（V）：释放一个空位，可能让等待的车进入</li>
</ul>

<hr />

<h2 id="struct-semaphore-详解"><span class="me-2">struct semaphore 详解</span><a href="#struct-semaphore-详解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">semaphore</span> 
  <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="n">value</span><span class="p">;</span>             <span class="cm">/**&lt; Current value. */</span>
    <span class="k">struct</span> <span class="n">list</span> <span class="n">waiters</span><span class="p">;</span>        <span class="cm">/**&lt; List of waiting threads. */</span>
  <span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>value</strong>：当前值</p>
<ul>
  <li>表示可用资源数</li>
  <li>value &gt; 0：有可用资源</li>
  <li>value == 0：无可用资源，需要等待</li>
</ul>

<p><strong>waiters</strong>：等待线程队列</p>
<ul>
  <li>当 value == 0 时，等待的线程在此队列中</li>
  <li>FIFO 顺序（先等待的先被唤醒）</li>
</ul>

<p><strong>内存布局</strong>：</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>struct semaphore
┌─────────────────────────┐
│   value (4 bytes)       │
├─────────────────────────┤
│   waiters.head.prev     │
│   waiters.head.next     │
│   waiters.tail.prev     │
│   waiters.tail.next     │
└─────────────────────────┘
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="sema_init-详解"><span class="me-2">sema_init() 详解</span><a href="#sema_init-详解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kt">void</span>
<span class="nf">sema_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">semaphore</span> <span class="o">*</span><span class="n">sema</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">value</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">sema</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="n">sema</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
  <span class="n">list_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sema</span><span class="o">-&gt;</span><span class="n">waiters</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>初始化信号量：</p>
<ol>
  <li>设置初始值</li>
  <li>初始化等待队列（空链表）</li>
</ol>

<p><strong>使用示例</strong>：</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">semaphore</span> <span class="n">sema</span><span class="p">;</span>
<span class="n">sema_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sema</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>  <span class="c1">// 二进制信号量，用于互斥</span>
<span class="n">sema_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sema</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>  <span class="c1">// 计数信号量，最多 5 个并发</span>
<span class="n">sema_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sema</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>  <span class="c1">// 用于同步，初始无资源</span>
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="sema_down-详解"><span class="me-2">sema_down() 详解</span><a href="#sema_down-详解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>这是<strong>等待</strong>操作（P 操作）：</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kt">void</span>
<span class="nf">sema_down</span> <span class="p">(</span><span class="k">struct</span> <span class="n">semaphore</span> <span class="o">*</span><span class="n">sema</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="k">enum</span> <span class="n">intr_level</span> <span class="n">old_level</span><span class="p">;</span>

  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">sema</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="o">!</span><span class="n">intr_context</span> <span class="p">());</span>  <span class="c1">// 不能在中断处理中调用</span>

  <span class="n">old_level</span> <span class="o">=</span> <span class="n">intr_disable</span> <span class="p">();</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">sema</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>    <span class="c1">// 循环等待</span>
    <span class="p">{</span>
      <span class="n">list_push_back</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sema</span><span class="o">-&gt;</span><span class="n">waiters</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">thread_current</span> <span class="p">()</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">);</span>
      <span class="n">thread_block</span> <span class="p">();</span>        <span class="c1">// 阻塞自己</span>
    <span class="p">}</span>
  <span class="n">sema</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">--</span><span class="p">;</span>              <span class="c1">// 获取资源</span>
  <span class="n">intr_set_level</span> <span class="p">(</span><span class="n">old_level</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="执行流程"><span class="me-2">执行流程</span><a href="#执行流程" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre>线程调用 sema_down(&amp;sema)
         │
         ▼
    禁用中断
         │
         ▼
    value == 0?  ─────► 是 ─────► 加入 waiters
         │                           │
         │ 否                        │
         │                           ▼
         │                      thread_block()
         │                           │
         │                           │ (被其他线程唤醒)
         │                           │
         │ ◄─────────────────────────┘
         │
         ▼
    value-- (获取资源)
         │
         ▼
    恢复中断
         │
         ▼
      返回
</pre></td></tr></tbody></table></code></div></div>

<h3 id="为什么用-while-而不是-if"><span class="me-2">为什么用 while 而不是 if？</span><a href="#为什么用-while-而不是-if" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>考虑多个线程等待的情况：</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>sema.value = 0
waiters: [A] → [B] → [C]

Thread D 调用 sema_up():
    1. 唤醒 A
    2. value++ (value = 1)

但如果在 A 被调度前，D 又调用了 sema_down():
    value-- (value = 0)

A 被调度后:
    如果用 if：直接执行 value--，但 value 已经是 0！
    如果用 while：重新检查，发现 value == 0，继续等待
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="sema_try_down-详解"><span class="me-2">sema_try_down() 详解</span><a href="#sema_try_down-详解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>这是<strong>非阻塞</strong>版本的 down 操作：</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="n">bool</span>
<span class="nf">sema_try_down</span> <span class="p">(</span><span class="k">struct</span> <span class="n">semaphore</span> <span class="o">*</span><span class="n">sema</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="k">enum</span> <span class="n">intr_level</span> <span class="n">old_level</span><span class="p">;</span>
  <span class="n">bool</span> <span class="n">success</span><span class="p">;</span>

  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">sema</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="n">old_level</span> <span class="o">=</span> <span class="n">intr_disable</span> <span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">sema</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> 
    <span class="p">{</span>
      <span class="n">sema</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">--</span><span class="p">;</span>
      <span class="n">success</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> 
    <span class="p">}</span>
  <span class="k">else</span>
    <span class="n">success</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="n">intr_set_level</span> <span class="p">(</span><span class="n">old_level</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">success</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>特点</strong>：</p>
<ul>
  <li>不会阻塞</li>
  <li>成功返回 true，失败返回 false</li>
  <li>可以在中断处理程序中调用</li>
</ul>

<p><strong>使用场景</strong>：</p>
<ul>
  <li>轮询资源是否可用</li>
  <li>不希望阻塞的情况</li>
</ul>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="n">sema_try_down</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">resource_sema</span><span class="p">))</span> <span class="p">{</span>
  <span class="c1">// 获得资源，使用它</span>
  <span class="n">use_resource</span> <span class="p">();</span>
  <span class="n">sema_up</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">resource_sema</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="c1">// 资源不可用，做其他事</span>
  <span class="n">do_something_else</span> <span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="sema_up-详解"><span class="me-2">sema_up() 详解</span><a href="#sema_up-详解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>这是<strong>信号</strong>操作（V 操作）：</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="kt">void</span>
<span class="nf">sema_up</span> <span class="p">(</span><span class="k">struct</span> <span class="n">semaphore</span> <span class="o">*</span><span class="n">sema</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="k">enum</span> <span class="n">intr_level</span> <span class="n">old_level</span><span class="p">;</span>

  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">sema</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="n">old_level</span> <span class="o">=</span> <span class="n">intr_disable</span> <span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sema</span><span class="o">-&gt;</span><span class="n">waiters</span><span class="p">))</span> 
    <span class="n">thread_unblock</span> <span class="p">(</span><span class="n">list_entry</span> <span class="p">(</span><span class="n">list_pop_front</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sema</span><span class="o">-&gt;</span><span class="n">waiters</span><span class="p">),</span>
                                <span class="k">struct</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">elem</span><span class="p">));</span>
  <span class="n">sema</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">++</span><span class="p">;</span>
  <span class="n">intr_set_level</span> <span class="p">(</span><span class="n">old_level</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="执行流程-1"><span class="me-2">执行流程</span><a href="#执行流程-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre>线程调用 sema_up(&amp;sema)
         │
         ▼
    禁用中断
         │
         ▼
    waiters 空?  ────► 否 ────► 取出队首线程
         │                        │
         │ 是                     │
         │                        ▼
         │                   thread_unblock()
         │                        │
         │ ◄──────────────────────┘
         │
         ▼
      value++
         │
         ▼
    恢复中断
         │
         ▼
      返回
</pre></td></tr></tbody></table></code></div></div>

<h3 id="先唤醒还是先递增"><span class="me-2">先唤醒还是先递增？</span><a href="#先唤醒还是先递增" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>当前实现：先唤醒，后递增。</p>

<p>这没有本质区别，因为：</p>
<ol>
  <li>整个操作在中断禁用下是原子的</li>
  <li>被唤醒的线程不会立即运行（只是变为 READY）</li>
</ol>

<hr />

<h2 id="信号量的使用模式"><span class="me-2">信号量的使用模式</span><a href="#信号量的使用模式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="1-互斥锁mutex"><span class="me-2">1. 互斥锁（Mutex）</span><a href="#1-互斥锁mutex" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">semaphore</span> <span class="n">mutex</span><span class="p">;</span>
<span class="n">sema_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>  <span class="c1">// 初始值为 1</span>

<span class="c1">// 临界区</span>
<span class="n">sema_down</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="c1">// ... 访问共享资源 ...</span>
<span class="n">sema_up</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="2-资源计数"><span class="me-2">2. 资源计数</span><a href="#2-资源计数" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="cp">#define MAX_CONNECTIONS 10
</span><span class="k">struct</span> <span class="n">semaphore</span> <span class="n">conn_sema</span><span class="p">;</span>
<span class="n">sema_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">conn_sema</span><span class="p">,</span> <span class="n">MAX_CONNECTIONS</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">handle_connection</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">sema_down</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">conn_sema</span><span class="p">);</span>  <span class="c1">// 获取连接槽</span>
  <span class="c1">// ... 处理连接 ...</span>
  <span class="n">sema_up</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">conn_sema</span><span class="p">);</span>    <span class="c1">// 释放连接槽</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="3-线程同步"><span class="me-2">3. 线程同步</span><a href="#3-线程同步" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">semaphore</span> <span class="n">sync_sema</span><span class="p">;</span>
<span class="n">sema_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sync_sema</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>  <span class="c1">// 初始值为 0</span>

<span class="c1">// 线程 A（等待者）</span>
<span class="kt">void</span> <span class="nf">thread_a</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">sema_down</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sync_sema</span><span class="p">);</span>   <span class="c1">// 等待线程 B 的信号</span>
  <span class="n">printf</span> <span class="p">(</span><span class="s">"B has finished!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 线程 B（通知者）</span>
<span class="kt">void</span> <span class="nf">thread_b</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">do_something</span> <span class="p">();</span>
  <span class="n">sema_up</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sync_sema</span><span class="p">);</span>     <span class="c1">// 通知线程 A</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="4-生产者-消费者"><span class="me-2">4. 生产者-消费者</span><a href="#4-生产者-消费者" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">semaphore</span> <span class="n">empty_slots</span><span class="p">;</span>  <span class="c1">// 空槽数</span>
<span class="k">struct</span> <span class="n">semaphore</span> <span class="n">filled_slots</span><span class="p">;</span> <span class="c1">// 满槽数</span>
<span class="k">struct</span> <span class="n">semaphore</span> <span class="n">mutex</span><span class="p">;</span>        <span class="c1">// 保护缓冲区</span>

<span class="n">sema_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">empty_slots</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">);</span>
<span class="n">sema_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">filled_slots</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">sema_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">producer</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">produce_item</span> <span class="p">();</span>
    <span class="n">sema_down</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">empty_slots</span><span class="p">);</span>  <span class="c1">// 等待空槽</span>
    <span class="n">sema_down</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>        <span class="c1">// 获取互斥锁</span>
    <span class="n">buffer_add</span> <span class="p">(</span><span class="n">item</span><span class="p">);</span>
    <span class="n">sema_up</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>          <span class="c1">// 释放互斥锁</span>
    <span class="n">sema_up</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">filled_slots</span><span class="p">);</span>   <span class="c1">// 增加满槽数</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">consumer</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sema_down</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">filled_slots</span><span class="p">);</span> <span class="c1">// 等待满槽</span>
    <span class="n">sema_down</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>        <span class="c1">// 获取互斥锁</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">buffer_remove</span> <span class="p">();</span>
    <span class="n">sema_up</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>          <span class="c1">// 释放互斥锁</span>
    <span class="n">sema_up</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">empty_slots</span><span class="p">);</span>    <span class="c1">// 增加空槽数</span>
    <span class="n">consume_item</span> <span class="p">(</span><span class="n">item</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="信号量状态图"><span class="me-2">信号量状态图</span><a href="#信号量状态图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre>                    sema_init(3)
                         │
                         ▼
                   ┌───────────┐
                   │ value = 3 │
                   │ waiters=[]│
                   └───────────┘
                         │
        ┌────────────────┼────────────────┐
        │ sema_down      │ sema_down      │ sema_down
        ▼                ▼                ▼
   ┌───────────┐   ┌───────────┐   ┌───────────┐
   │ value = 2 │   │ value = 1 │   │ value = 0 │
   │ waiters=[]│   │ waiters=[]│   │ waiters=[]│
   └───────────┘   └───────────┘   └───────────┘
                                        │
                                        │ sema_down (Thread A)
                                        ▼
                                   ┌───────────┐
                                   │ value = 0 │
                                   │waiters=[A]│
                                   └───────────┘
                                        │
                                        │ sema_up
                                        ▼
                                   ┌───────────┐
                                   │ value = 1 │
                                   │ waiters=[]│  A 被唤醒
                                   └───────────┘
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="sema_self_test-自测试"><span class="me-2">sema_self_test() 自测试</span><a href="#sema_self_test-自测试" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="cm">/** Self-test for semaphores that makes control "ping-pong"
   between a pair of threads. */</span>
<span class="kt">void</span>
<span class="nf">sema_self_test</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">semaphore</span> <span class="n">sema</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

  <span class="n">printf</span> <span class="p">(</span><span class="s">"Testing semaphores..."</span><span class="p">);</span>
  <span class="n">sema_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sema</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">sema_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sema</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">thread_create</span> <span class="p">(</span><span class="s">"sema-test"</span><span class="p">,</span> <span class="n">PRI_DEFAULT</span><span class="p">,</span> <span class="n">sema_test_helper</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sema</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> 
    <span class="p">{</span>
      <span class="n">sema_up</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sema</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>    <span class="c1">// 通知 helper</span>
      <span class="n">sema_down</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sema</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>  <span class="c1">// 等待 helper</span>
    <span class="p">}</span>
  <span class="n">printf</span> <span class="p">(</span><span class="s">"done.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sema_test_helper</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">sema_</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">semaphore</span> <span class="o">*</span><span class="n">sema</span> <span class="o">=</span> <span class="n">sema_</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> 
    <span class="p">{</span>
      <span class="n">sema_down</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sema</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>  <span class="c1">// 等待主线程</span>
      <span class="n">sema_up</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sema</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>    <span class="c1">// 通知主线程</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>这个测试展示了信号量用于线程同步的”乒乓”模式。</p>

<hr />

<h2 id="常见问题"><span class="me-2">常见问题</span><a href="#常见问题" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="q1-为什么信号量不能有负值"><span class="me-2">Q1: 为什么信号量不能有负值？</span><a href="#q1-为什么信号量不能有负值" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>答</strong>：Pintos 使用 <code class="language-plaintext highlighter-rouge">unsigned</code> 存储 value，不能为负。概念上，负值表示等待的线程数，但 Pintos 用 waiters 队列的长度来表示。</p>

<h3 id="q2-sema_down-和-sema_up-必须成对出现吗"><span class="me-2">Q2: sema_down 和 sema_up 必须成对出现吗？</span><a href="#q2-sema_down-和-sema_up-必须成对出现吗" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>答</strong>：不一定。取决于用途：</p>
<ul>
  <li>用于互斥时，应该成对</li>
  <li>用于同步时，可能由不同线程调用</li>
  <li>用于资源计数时，取决于资源的生命周期</li>
</ul>

<h3 id="q3-信号量可以在中断处理程序中使用吗"><span class="me-2">Q3: 信号量可以在中断处理程序中使用吗？</span><a href="#q3-信号量可以在中断处理程序中使用吗" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>答</strong>：</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">sema_up()</code>：可以</li>
  <li><code class="language-plaintext highlighter-rouge">sema_try_down()</code>：可以</li>
  <li><code class="language-plaintext highlighter-rouge">sema_down()</code>：<strong>不可以</strong>（会阻塞）</li>
</ul>

<h3 id="q4-唤醒的线程会立即运行吗"><span class="me-2">Q4: 唤醒的线程会立即运行吗？</span><a href="#q4-唤醒的线程会立即运行吗" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>答</strong>：不会。<code class="language-plaintext highlighter-rouge">thread_unblock()</code> 只是把线程加入 ready_list。被唤醒的线程会在将来某时刻被调度运行。</p>

<h3 id="q5-为什么信号量的-value-使用-unsigned"><span class="me-2">Q5: 为什么信号量的 value 使用 unsigned？</span><a href="#q5-为什么信号量的-value-使用-unsigned" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>答</strong>：概念上信号量值不应该为负。使用 unsigned 可以在编译时捕获一些错误，并明确表示设计意图。</p>

<hr />

<h2 id="练习思考"><span class="me-2">练习思考</span><a href="#练习思考" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<ol>
  <li>
    <p><strong>分析题</strong>：如果把 sema_down 中的 while 改成 if，给出一个会出错的场景。</p>
  </li>
  <li>
    <p><strong>设计题</strong>：如何实现一个”公平”的信号量，保证等待最久的线程先被唤醒？</p>
  </li>
  <li>
    <p><strong>编程题</strong>：用信号量实现一个有界缓冲区（bounded buffer）。</p>
  </li>
  <li>
    <p><strong>思考题</strong>：信号量和条件变量的本质区别是什么？</p>
  </li>
  <li>
    <p><strong>扩展题</strong>：研究”信号量的优先级反转问题”，并思考如何解决。</p>
  </li>
</ol>

<hr />

<h2 id="下一步"><span class="me-2">下一步</span><a href="#下一步" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>理解了信号量后，下一篇文档将介绍<strong>锁（Lock）</strong>的实现，它是信号量的一个重要应用。</p>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/%E6%8A%80%E6%9C%AF/">技术</a>,
          <a href="/categories/pintos/">Pintos</a>
      </div>
    

    <!-- tags -->
    
      <div class="post-tags">
        <i class="fa fa-tags fa-fw me-1"></i>
        
          <a
            href="/tags/os/"
            class="post-tag no-text-decoration"
          >OS</a>
        
          <a
            href="/tags/pintos/"
            class="post-tag no-text-decoration"
          >Pintos</a>
        
          <a
            href="/tags/%E5%90%8C%E6%AD%A5/"
            class="post-tag no-text-decoration"
          >同步</a>
        
          <a
            href="/tags/%E4%BF%A1%E5%8F%B7%E9%87%8F/"
            class="post-tag no-text-decoration"
          >信号量</a>
        
      </div>
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          本文由作者按照 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         进行授权
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">分享</span>
  <span class="share-icons">
    
    
    

    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="分享链接"
      data-title-succeed="链接已复制！"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">最近更新</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pintos-thread-03-create/">Pintos 线程系统详解（三）：线程创建</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pintos-thread-04-schedule/">Pintos 线程系统详解（四）：线程调度</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pintos-thread-05-switch/">Pintos 线程系统详解（五）：上下文切换</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pintos-thread-06-block-unblock/">Pintos 线程系统详解（六）：阻塞与唤醒</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pintos-thread-07-semaphore/">Pintos 线程系统详解（七）：信号量</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">热门标签</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/os/">OS</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/pintos/">Pintos</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E6%B1%87%E7%BC%96/">汇编</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%BC%95%E5%AF%BC%E5%8A%A0%E8%BD%BD%E7%A8%8B%E5%BA%8F/">引导加载程序</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E7%BA%BF%E7%A8%8B/">线程</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%86%85%E6%A0%B8/">内核</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%90%8C%E6%AD%A5/">同步</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/c%E8%AF%AD%E8%A8%80/">C语言</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/gdt/">GDT</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/x86/">x86</a>
      
    </div>
  </section>


            </div>

            
              
              






  <div class="toc-border-cover z-3"></div>
  <section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4">
    <h2 class="panel-heading ps-3 pb-2 mb-0">文章内容</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->















  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">相关文章</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/pintos-thread-09-condition/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1769356800"
  data-df="YYYY/MM/DD"
  
>
  2026/01/26
</time>

              <h4 class="pt-0 my-2">Pintos 线程系统详解（九）：条件变量</h4>
              <div class="text-muted">
                <p>详细解析 Pintos 中条件变量（Condition Variable）的实现，理解高级同步机制。</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/pintos-thread-08-lock/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1769356800"
  data-df="YYYY/MM/DD"
  
>
  2026/01/26
</time>

              <h4 class="pt-0 my-2">Pintos 线程系统详解（八）：锁</h4>
              <div class="text-muted">
                <p>详细解析 Pintos 中锁（Lock）的实现，理解互斥机制。</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/pintos-thread-06-block-unblock/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1769356800"
  data-df="YYYY/MM/DD"
  
>
  2026/01/26
</time>

              <h4 class="pt-0 my-2">Pintos 线程系统详解（六）：阻塞与唤醒</h4>
              <div class="text-muted">
                <p>详细解析 Pintos 中线程的阻塞与唤醒机制，包括 thread_block() 和 thread_unblock() 函数。</p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/pintos-thread-06-block-unblock/"
      class="btn btn-outline-primary"
      aria-label="上一篇"
    >
      <p>Pintos 线程系统详解（六）：阻塞与唤醒</p>
    </a>
  

  
    <a
      href="/posts/pintos-thread-08-lock/"
      class="btn btn-outline-primary"
      aria-label="下一篇"
    >
      <p>Pintos 线程系统详解（八）：锁</p>
    </a>
  
</nav>

            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>©
    <time>2026</time>

    
      <a href="https://github.com/zxsheather">Zxsheather</a>.
    

    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。"
      >保留部分权利。</span>
    
  </p>

  <p>本站采用 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 主题 <a
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="v7.4.1"
        href="https://github.com/cotes2020/jekyll-theme-chirpy"
        target="_blank"
        rel="noopener"
      >Chirpy</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center d-none">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">热门标签</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/os/">OS</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/pintos/">Pintos</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E6%B1%87%E7%BC%96/">汇编</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%BC%95%E5%AF%BC%E5%8A%A0%E8%BD%BD%E7%A8%8B%E5%BA%8F/">引导加载程序</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E7%BA%BF%E7%A8%8B/">线程</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%86%85%E6%A0%B8/">内核</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%90%8C%E6%AD%A5/">同步</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/c%E8%AF%AD%E8%A8%80/">C语言</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/gdt/">GDT</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/x86/">x86</a>
      
    </div>
  </section>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">发现新版本的内容。</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      更新
    </button>
  </div>
</aside>

    

    <!-- Embedded scripts -->

    
      
      <!-- The comments switcher -->


    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  
  document.addEventListener('DOMContentLoaded', () => {
    SimpleJekyllSearch({
      searchInput: document.getElementById('search-input'),
      resultsContainer: document.getElementById('search-results'),
      json: '/assets/js/data/search.json',
      searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{content}</p>  </article>',
      noResultsText: '<p class="mt-5">搜索结果为空</p>',
      templateMiddleware: function(prop, value, template) {
        if (prop === 'categories') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
          }
        }

        if (prop === 'tags') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
          }
        }
      }
    });
  });
</script>

  </body>
</html>

