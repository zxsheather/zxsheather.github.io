<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="zh-CN" >
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  ><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Pintos 线程系统详解（三）：线程创建" />
<meta property="og:locale" content="zh_CN" />
<meta name="description" content="详细解析 Pintos 中 thread_create() 函数的实现，理解线程如何被创建和初始化。" />
<meta property="og:description" content="详细解析 Pintos 中 thread_create() 函数的实现，理解线程如何被创建和初始化。" />
<link rel="canonical" href="http://localhost:4000/posts/pintos-thread-03-create/" />
<meta property="og:url" content="http://localhost:4000/posts/pintos-thread-03-create/" />
<meta property="og:site_name" content="Zxsheather" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2026-01-26T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Pintos 线程系统详解（三）：线程创建" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2026-01-26T00:00:00+08:00","datePublished":"2026-01-26T00:00:00+08:00","description":"详细解析 Pintos 中 thread_create() 函数的实现，理解线程如何被创建和初始化。","headline":"Pintos 线程系统详解（三）：线程创建","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/pintos-thread-03-create/"},"url":"http://localhost:4000/posts/pintos-thread-03-create/"}</script>
<!-- End Jekyll SEO tag -->


  <title>Pintos 线程系统详解（三）：线程创建 | Zxsheather
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="icon" type="image/png" href="/assets/img/favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/svg+xml" href="/assets/img/favicons/favicon.svg">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">

  <link rel="manifest" href="/assets/img/favicons/site.webmanifest">



  <!-- Resource Hints -->
  
    
      
        <link rel="preconnect" href="https://fonts.googleapis.com" >
      
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
      
    
      
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" >
      
    
      
        <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      
        <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
      
    
  

  <!-- Bootstrap -->
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
  

  <!-- Theme style -->
  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  <!-- Web Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css">

  <!-- 3rd-party Dependencies -->

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.36.4/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Image Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css">
  

  <!-- Scripts -->

  <script src="/assets/js/dist/theme.min.js"></script>

  <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.18/dayjs.min.js,npm/dayjs@1.11.18/locale/zh.js,npm/dayjs@1.11.18/plugin/relativeTime.js,npm/dayjs@1.11.18/plugin/localizedFormat.js,npm/tocbot@4.36.4/dist/tocbot.min.js,npm/mermaid@11.12.0/dist/mermaid.min.js"></script>







<script defer src="/assets/js/dist/post.min.js"></script>



<!-- Pageviews -->

  

  



  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/3.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <a class="site-title d-block" href="/">Zxsheather</a>
    <p class="site-subtitle fst-italic mb-0">A CS Undergraduate</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>首页</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>分类</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>标签</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>归档</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>关于</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    
      <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle">
        <i class="fas fa-adjust"></i>
      </button>

      
    

    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">首页</a>
            </span>

          
        
          
        
          
            
              <span>Pintos 线程系统详解（三）：线程创建</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      文章
    </div>

    <button type="button" id="search-trigger" class="btn btn-link" aria-label="Search">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search id="search" class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="搜索..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">取消</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->





<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->










<article class="px-1" data-toc="true">
  <header>
    <h1 data-toc-skip>Pintos 线程系统详解（三）：线程创建</h1>
    
      <p class="post-desc fw-light mb-4">详细解析 Pintos 中 thread_create() 函数的实现，理解线程如何被创建和初始化。</p>
    

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        发表于
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1769356800"
  data-df="YYYY/MM/DD"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  2026/01/26
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          作者

          <em>
            
              <a href="https://github.com/zxsheather">Zxsheather</a>
            
          </em>
        </span>

        <div>
          <!-- pageviews -->
          

          <!-- read time -->
          <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="3432 字"
>
  <em>19 分钟</em>阅读</span>

        </div>
      </div>
    </div>
  </header>

  
    <div id="toc-bar" class="d-flex align-items-center justify-content-between invisible">
      <span class="label text-truncate">Pintos 线程系统详解（三）：线程创建</span>
      <button type="button" class="toc-trigger btn me-1">
        <i class="fa-solid fa-list-ul fa-fw"></i>
      </button>
    </div>

    <button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm">
      <span class="label ps-2 pe-1">文章内容</span>
      <i class="fa-solid fa-angle-right fa-fw"></i>
    </button>

    <dialog id="toc-popup" class="p-0">
      <div class="header d-flex flex-row align-items-center justify-content-between">
        <div class="label text-truncate py-2 ms-4">Pintos 线程系统详解（三）：线程创建</div>
        <button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75">
          <i class="fas fa-close"></i>
        </button>
      </div>
      <div id="toc-popup-content" class="px-4 py-3 pb-4"></div>
    </dialog>
  

  <div class="content">
    <h2 id="概述"><span class="me-2">概述</span><a href="#概述" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>本文档详细解析 Pintos 中线程创建的过程。<code class="language-plaintext highlighter-rouge">thread_create()</code> 是创建新线程的核心函数，它负责：</p>
<ol>
  <li>分配内存（一个 4KB 页）</li>
  <li>初始化线程结构体</li>
  <li>设置初始栈帧</li>
  <li>将线程加入就绪队列</li>
</ol>

<p>理解这个函数是理解线程如何开始执行的关键。</p>

<hr />

<h2 id="原始代码"><span class="me-2">原始代码</span><a href="#原始代码" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="thread_create-函数"><span class="me-2">thread_create() 函数</span><a href="#thread_create-函数" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre></td><td class="rouge-code"><pre><span class="cm">/** Creates a new kernel thread named NAME with the given initial
   PRIORITY, which executes FUNCTION passing AUX as the argument,
   and adds it to the ready queue.  Returns the thread identifier
   for the new thread, or TID_ERROR if creation fails.

   If thread_start() has been called, then the new thread may be
   scheduled before thread_create() returns.  It could even exit
   before thread_create() returns.  Contrariwise, the original
   thread may run for any amount of time before the new thread is
   scheduled.  Use a semaphore or some other form of
   synchronization if you need to ensure ordering.

   The code provided sets the new thread's `priority' member to
   PRIORITY, but no actual priority scheduling is implemented.
   Priority scheduling is the goal of Problem 1-3. */</span>
<span class="n">tid_t</span>
<span class="nf">thread_create</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">priority</span><span class="p">,</span>
               <span class="n">thread_func</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">aux</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">kernel_thread_frame</span> <span class="o">*</span><span class="n">kf</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">switch_entry_frame</span> <span class="o">*</span><span class="n">ef</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">switch_threads_frame</span> <span class="o">*</span><span class="n">sf</span><span class="p">;</span>
  <span class="n">tid_t</span> <span class="n">tid</span><span class="p">;</span>

  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">function</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="cm">/* Allocate thread. */</span>
  <span class="n">t</span> <span class="o">=</span> <span class="n">palloc_get_page</span> <span class="p">(</span><span class="n">PAL_ZERO</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">TID_ERROR</span><span class="p">;</span>

  <span class="cm">/* Initialize thread. */</span>
  <span class="n">init_thread</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">priority</span><span class="p">);</span>
  <span class="n">tid</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tid</span> <span class="o">=</span> <span class="n">allocate_tid</span> <span class="p">();</span>

  <span class="cm">/* Stack frame for kernel_thread(). */</span>
  <span class="n">kf</span> <span class="o">=</span> <span class="n">alloc_frame</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">kf</span><span class="p">);</span>
  <span class="n">kf</span><span class="o">-&gt;</span><span class="n">eip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">kf</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">function</span><span class="p">;</span>
  <span class="n">kf</span><span class="o">-&gt;</span><span class="n">aux</span> <span class="o">=</span> <span class="n">aux</span><span class="p">;</span>

  <span class="cm">/* Stack frame for switch_entry(). */</span>
  <span class="n">ef</span> <span class="o">=</span> <span class="n">alloc_frame</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">ef</span><span class="p">);</span>
  <span class="n">ef</span><span class="o">-&gt;</span><span class="n">eip</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">))</span> <span class="n">kernel_thread</span><span class="p">;</span>

  <span class="cm">/* Stack frame for switch_threads(). */</span>
  <span class="n">sf</span> <span class="o">=</span> <span class="n">alloc_frame</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">sf</span><span class="p">);</span>
  <span class="n">sf</span><span class="o">-&gt;</span><span class="n">eip</span> <span class="o">=</span> <span class="n">switch_entry</span><span class="p">;</span>
  <span class="n">sf</span><span class="o">-&gt;</span><span class="n">ebp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="cm">/* Add to run queue. */</span>
  <span class="n">thread_unblock</span> <span class="p">(</span><span class="n">t</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">tid</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="init_thread-函数"><span class="me-2">init_thread() 函数</span><a href="#init_thread-函数" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="cm">/** Does basic initialization of T as a blocked thread named NAME. */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">init_thread</span> <span class="p">(</span><span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">priority</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">enum</span> <span class="n">intr_level</span> <span class="n">old_level</span><span class="p">;</span>

  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">t</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">PRI_MIN</span> <span class="o">&lt;=</span> <span class="n">priority</span> <span class="o">&amp;&amp;</span> <span class="n">priority</span> <span class="o">&lt;=</span> <span class="n">PRI_MAX</span><span class="p">);</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="n">memset</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">t</span><span class="p">);</span>
  <span class="n">t</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">THREAD_BLOCKED</span><span class="p">;</span>
  <span class="n">strlcpy</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
  <span class="n">t</span><span class="o">-&gt;</span><span class="n">stack</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">t</span> <span class="o">+</span> <span class="n">PGSIZE</span><span class="p">;</span>
  <span class="n">t</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">priority</span><span class="p">;</span>
  <span class="n">t</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">THREAD_MAGIC</span><span class="p">;</span>

  <span class="n">old_level</span> <span class="o">=</span> <span class="n">intr_disable</span> <span class="p">();</span>
  <span class="n">list_push_back</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">all_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">allelem</span><span class="p">);</span>
  <span class="n">intr_set_level</span> <span class="p">(</span><span class="n">old_level</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="alloc_frame-函数"><span class="me-2">alloc_frame() 函数</span><a href="#alloc_frame-函数" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="cm">/** Allocates a SIZE-byte frame at the top of thread T's stack and
   returns a pointer to the frame's base. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">alloc_frame</span> <span class="p">(</span><span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="cm">/* Stack data is always allocated in word-size units. */</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">is_thread</span> <span class="p">(</span><span class="n">t</span><span class="p">));</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">size</span> <span class="o">%</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

  <span class="n">t</span><span class="o">-&gt;</span><span class="n">stack</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">stack</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="kernel_thread-函数"><span class="me-2">kernel_thread() 函数</span><a href="#kernel_thread-函数" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="cm">/** Function used as the basis for a kernel thread. */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">kernel_thread</span> <span class="p">(</span><span class="n">thread_func</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">aux</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">function</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="n">intr_enable</span> <span class="p">();</span>       <span class="cm">/**&lt; The scheduler runs with interrupts off. */</span>
  <span class="n">function</span> <span class="p">(</span><span class="n">aux</span><span class="p">);</span>       <span class="cm">/**&lt; Execute the thread function. */</span>
  <span class="n">thread_exit</span> <span class="p">();</span>       <span class="cm">/**&lt; If function() returns, kill the thread. */</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="前置知识"><span class="me-2">前置知识</span><a href="#前置知识" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="1-函数调用约定"><span class="me-2">1. 函数调用约定</span><a href="#1-函数调用约定" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>在 x86 32 位系统中，函数调用遵循以下约定（cdecl）：</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>调用前:
┌──────────────────┐
│     参数 n       │  高地址
│     ...          │
│     参数 2       │
│     参数 1       │
│   返回地址       │  ← call 指令自动压入
└──────────────────┘  ← ESP（调用后）

函数开头:
push %ebp          ; 保存旧 ebp
mov %esp, %ebp     ; 建立栈帧
</pre></td></tr></tbody></table></code></div></div>

<h3 id="2-栈帧结构"><span class="me-2">2. 栈帧结构</span><a href="#2-栈帧结构" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>每个函数调用都会建立一个栈帧：</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>高地址
┌──────────────────┐
│   参数 n         │
│   ...            │
│   参数 1         │
├──────────────────┤
│   返回地址       │  ← call 指令压入
├──────────────────┤
│   旧 EBP         │  ← 当前 EBP 指向这里
├──────────────────┤
│   局部变量 1     │
│   ...            │
│   局部变量 n     │  ← ESP
└──────────────────┘
低地址
</pre></td></tr></tbody></table></code></div></div>

<h3 id="3-栈帧类型定义"><span class="me-2">3. 栈帧类型定义</span><a href="#3-栈帧类型定义" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="cm">/* switch.h */</span>

<span class="cm">/** switch_thread()'s stack frame. */</span>
<span class="k">struct</span> <span class="n">switch_threads_frame</span> 
  <span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">edi</span><span class="p">;</span>               <span class="cm">/**&lt;  0: Saved %edi. */</span>
    <span class="kt">uint32_t</span> <span class="n">esi</span><span class="p">;</span>               <span class="cm">/**&lt;  4: Saved %esi. */</span>
    <span class="kt">uint32_t</span> <span class="n">ebp</span><span class="p">;</span>               <span class="cm">/**&lt;  8: Saved %ebp. */</span>
    <span class="kt">uint32_t</span> <span class="n">ebx</span><span class="p">;</span>               <span class="cm">/**&lt; 12: Saved %ebx. */</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">eip</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>         <span class="cm">/**&lt; 16: Return address. */</span>
    <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>         <span class="cm">/**&lt; 20: switch_threads()'s CUR argument. */</span>
    <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>        <span class="cm">/**&lt; 24: switch_threads()'s NEXT argument. */</span>
  <span class="p">};</span>

<span class="cm">/** Stack frame for switch_entry(). */</span>
<span class="k">struct</span> <span class="n">switch_entry_frame</span>
  <span class="p">{</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">eip</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
  <span class="p">};</span>

<span class="cm">/* thread.c */</span>

<span class="cm">/** Stack frame for kernel_thread(). */</span>
<span class="k">struct</span> <span class="n">kernel_thread_frame</span> 
  <span class="p">{</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">eip</span><span class="p">;</span>                  <span class="cm">/**&lt; Return address. */</span>
    <span class="n">thread_func</span> <span class="o">*</span><span class="n">function</span><span class="p">;</span>      <span class="cm">/**&lt; Function to call. */</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">aux</span><span class="p">;</span>                  <span class="cm">/**&lt; Auxiliary data for function. */</span>
  <span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="逐步详解"><span class="me-2">逐步详解</span><a href="#逐步详解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="第一步参数检查和内存分配"><span class="me-2">第一步：参数检查和内存分配</span><a href="#第一步参数检查和内存分配" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="n">tid_t</span>
<span class="nf">thread_create</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">priority</span><span class="p">,</span>
               <span class="n">thread_func</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">aux</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">kernel_thread_frame</span> <span class="o">*</span><span class="n">kf</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">switch_entry_frame</span> <span class="o">*</span><span class="n">ef</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">switch_threads_frame</span> <span class="o">*</span><span class="n">sf</span><span class="p">;</span>
  <span class="n">tid_t</span> <span class="n">tid</span><span class="p">;</span>

  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">function</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>  <span class="c1">// function 不能为 NULL</span>

  <span class="cm">/* Allocate thread. */</span>
  <span class="n">t</span> <span class="o">=</span> <span class="n">palloc_get_page</span> <span class="p">(</span><span class="n">PAL_ZERO</span><span class="p">);</span>  <span class="c1">// 分配一个全零的页</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">TID_ERROR</span><span class="p">;</span>  <span class="c1">// 内存不足</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>palloc_get_page(PAL_ZERO)</strong>：</p>
<ul>
  <li>分配一个 4KB 页</li>
  <li>PAL_ZERO 标志表示将页内容清零</li>
  <li>返回页的起始地址（页对齐）</li>
</ul>

<p><strong>内存布局（刚分配完）</strong>：</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>        4096 ┌─────────────────────┐
             │                     │
             │    全是 0           │
             │                     │
             │                     │
             │                     │
             │                     │
             │                     │
             │                     │
           0 └─────────────────────┘ ← t 指向这里
</pre></td></tr></tbody></table></code></div></div>

<h3 id="第二步初始化线程结构"><span class="me-2">第二步：初始化线程结构</span><a href="#第二步初始化线程结构" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>  <span class="cm">/* Initialize thread. */</span>
  <span class="n">init_thread</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">priority</span><span class="p">);</span>
  <span class="n">tid</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tid</span> <span class="o">=</span> <span class="n">allocate_tid</span> <span class="p">();</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>init_thread() 详解</strong>：</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">init_thread</span> <span class="p">(</span><span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">priority</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">t</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">PRI_MIN</span> <span class="o">&lt;=</span> <span class="n">priority</span> <span class="o">&amp;&amp;</span> <span class="n">priority</span> <span class="o">&lt;=</span> <span class="n">PRI_MAX</span><span class="p">);</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="n">memset</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">t</span><span class="p">);</span>           <span class="c1">// 清零（虽然 PAL_ZERO 已经做了）</span>
  <span class="n">t</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">THREAD_BLOCKED</span><span class="p">;</span>          <span class="c1">// 初始状态为阻塞</span>
  <span class="n">strlcpy</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>  <span class="c1">// 复制名称（最多 15 字符）</span>
  <span class="n">t</span><span class="o">-&gt;</span><span class="n">stack</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">t</span> <span class="o">+</span> <span class="n">PGSIZE</span><span class="p">;</span>   <span class="c1">// 栈指针指向页顶</span>
  <span class="n">t</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">priority</span><span class="p">;</span>              <span class="c1">// 设置优先级</span>
  <span class="n">t</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">THREAD_MAGIC</span><span class="p">;</span>             <span class="c1">// 设置魔数</span>

  <span class="c1">// 加入 all_list</span>
  <span class="n">old_level</span> <span class="o">=</span> <span class="n">intr_disable</span> <span class="p">();</span>
  <span class="n">list_push_back</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">all_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">allelem</span><span class="p">);</span>
  <span class="n">intr_set_level</span> <span class="p">(</span><span class="n">old_level</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>内存布局（init_thread 后）</strong>：</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>        4096 ┌─────────────────────┐ ← t-&gt;stack 初始值
             │                     │
             │    (栈空间)         │
             │                     │
             │                     │
             ├─────────────────────┤
             │      magic          │
             │      priority       │
             │      stack (指针)   │
             │      name[16]       │
             │      status         │
             │      tid            │
           0 └─────────────────────┘ ← t
</pre></td></tr></tbody></table></code></div></div>

<h3 id="第三步设置栈帧"><span class="me-2">第三步：设置栈帧</span><a href="#第三步设置栈帧" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>这是最关键的部分！我们需要设置三层栈帧：</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>  <span class="cm">/* Stack frame for kernel_thread(). */</span>
  <span class="n">kf</span> <span class="o">=</span> <span class="n">alloc_frame</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">kf</span><span class="p">);</span>
  <span class="n">kf</span><span class="o">-&gt;</span><span class="n">eip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">kf</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">function</span><span class="p">;</span>
  <span class="n">kf</span><span class="o">-&gt;</span><span class="n">aux</span> <span class="o">=</span> <span class="n">aux</span><span class="p">;</span>

  <span class="cm">/* Stack frame for switch_entry(). */</span>
  <span class="n">ef</span> <span class="o">=</span> <span class="n">alloc_frame</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">ef</span><span class="p">);</span>
  <span class="n">ef</span><span class="o">-&gt;</span><span class="n">eip</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">))</span> <span class="n">kernel_thread</span><span class="p">;</span>

  <span class="cm">/* Stack frame for switch_threads(). */</span>
  <span class="n">sf</span> <span class="o">=</span> <span class="n">alloc_frame</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">sf</span><span class="p">);</span>
  <span class="n">sf</span><span class="o">-&gt;</span><span class="n">eip</span> <span class="o">=</span> <span class="n">switch_entry</span><span class="p">;</span>
  <span class="n">sf</span><span class="o">-&gt;</span><span class="n">ebp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>alloc_frame() 的工作</strong>：</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">alloc_frame</span> <span class="p">(</span><span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="n">t</span><span class="o">-&gt;</span><span class="n">stack</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>   <span class="c1">// 栈向下增长</span>
  <span class="k">return</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">stack</span><span class="p">;</span>    <span class="c1">// 返回新的栈顶</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>让我们一步步看栈的变化：</p>

<p><strong>初始状态</strong>：</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>        4096 ┌─────────────────────┐ ← t-&gt;stack
             │                     │
             │                     │
             │                     │
</pre></td></tr></tbody></table></code></div></div>

<p><strong>设置 kernel_thread_frame 后</strong>：</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">kf</span> <span class="o">=</span> <span class="n">alloc_frame</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">kf</span><span class="p">);</span>  <span class="c1">// 12 字节</span>
<span class="n">kf</span><span class="o">-&gt;</span><span class="n">eip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="n">kf</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">function</span><span class="p">;</span>
<span class="n">kf</span><span class="o">-&gt;</span><span class="n">aux</span> <span class="o">=</span> <span class="n">aux</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>        4096 ┌─────────────────────┐
             │       aux           │  4 字节
             │     function        │  4 字节
             │     eip (NULL)      │  4 字节
        4084 ├─────────────────────┤ ← t-&gt;stack, kf
             │                     │
</pre></td></tr></tbody></table></code></div></div>

<p><strong>设置 switch_entry_frame 后</strong>：</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">ef</span> <span class="o">=</span> <span class="n">alloc_frame</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">ef</span><span class="p">);</span>  <span class="c1">// 4 字节</span>
<span class="n">ef</span><span class="o">-&gt;</span><span class="n">eip</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">))</span> <span class="n">kernel_thread</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>        4096 ┌─────────────────────┐
             │       aux           │
             │     function        │
             │     eip (NULL)      │  ← kf
        4084 ├─────────────────────┤
             │ eip (kernel_thread) │  ← ef
        4080 ├─────────────────────┤ ← t-&gt;stack
             │                     │
</pre></td></tr></tbody></table></code></div></div>

<p><strong>设置 switch_threads_frame 后</strong>：</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">sf</span> <span class="o">=</span> <span class="n">alloc_frame</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">sf</span><span class="p">);</span>  <span class="c1">// 28 字节</span>
<span class="n">sf</span><span class="o">-&gt;</span><span class="n">eip</span> <span class="o">=</span> <span class="n">switch_entry</span><span class="p">;</span>
<span class="n">sf</span><span class="o">-&gt;</span><span class="n">ebp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="c1">// edi, esi, ebx 保持为 0（PAL_ZERO）</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>        4096 ┌─────────────────────┐
             │       aux           │
             │     function        │
             │     eip (NULL)      │  ← kf
        4084 ├─────────────────────┤
             │ eip (kernel_thread) │  ← ef
        4080 ├─────────────────────┤
             │    next (未设置)    │  28: 参数
             │    cur (未设置)     │  24: 参数
             │  eip (switch_entry) │  20: 返回地址
             │    ebx (0)          │  16:
             │    ebp (0)          │  12:
             │    esi (0)          │   8:
             │    edi (0)          │   4:
        4052 ├─────────────────────┤ ← t-&gt;stack, sf
             │                     │
</pre></td></tr></tbody></table></code></div></div>

<h3 id="第四步加入就绪队列"><span class="me-2">第四步：加入就绪队列</span><a href="#第四步加入就绪队列" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>  <span class="cm">/* Add to run queue. */</span>
  <span class="n">thread_unblock</span> <span class="p">(</span><span class="n">t</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">tid</span><span class="p">;</span>
<span class="err">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">thread_unblock(t)</code> 将线程从 BLOCKED 变为 READY，加入 ready_list。</p>

<hr />

<h2 id="完整栈帧布局"><span class="me-2">完整栈帧布局</span><a href="#完整栈帧布局" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre>高地址
4096    ┌───────────────────────────────────────────┐
        │               aux                         │ ┐
        │             function                      │ │ kernel_thread_frame
        │           eip (NULL)                      │ ┘ (12 bytes)
        ├───────────────────────────────────────────┤
        │         eip (kernel_thread)               │   switch_entry_frame
        ├───────────────────────────────────────────┤   (4 bytes)
        │    next  (未初始化，由 schedule 设置)     │ ┐
        │    cur   (未初始化，由 schedule 设置)     │ │
        │    eip   (switch_entry)                   │ │ switch_threads_frame
        │    ebx   (0)                              │ │ (28 bytes)
        │    ebp   (0)                              │ │
        │    esi   (0)                              │ │
        │    edi   (0)                              │ ┘
        ├───────────────────────────────────────────┤ ← t-&gt;stack
        │                                           │
        │         (栈增长空间 - 未使用)             │
        │    kernel_thread() 执行时使用此空间      │
        │                                           │
        ├───────────────────────────────────────────┤
        │              magic                        │
        │            (其他字段)                     │
        │           struct thread                   │
0       └───────────────────────────────────────────┘ ← t
低地址
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="新线程如何开始执行"><span class="me-2">新线程如何开始执行？</span><a href="#新线程如何开始执行" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>这是理解线程系统的关键！让我们跟踪新线程第一次被调度的过程：</p>

<h3 id="1-调度器选中新线程"><span class="me-2">1. 调度器选中新线程</span><a href="#1-调度器选中新线程" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">schedule</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="n">running_thread</span> <span class="p">();</span>
  <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">next_thread_to_run</span> <span class="p">();</span>  <span class="c1">// 选中新线程</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">!=</span> <span class="n">next</span><span class="p">)</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="n">switch_threads</span> <span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>  <span class="c1">// 切换到新线程</span>
  <span class="n">thread_schedule_tail</span> <span class="p">(</span><span class="n">prev</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="2-switch_threads-切换"><span class="me-2">2. switch_threads() 切换</span><a href="#2-switch_threads-切换" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre>switch_threads:
    # 保存旧线程的寄存器
    pushl %ebx
    pushl %ebp
    pushl %esi
    pushl %edi

    # 保存旧线程的栈指针
    mov thread_stack_ofs, %edx
    movl SWITCH_CUR(%esp), %eax
    movl %esp, (%eax,%edx,1)      # cur-&gt;stack = esp

    # 恢复新线程的栈指针
    movl SWITCH_NEXT(%esp), %ecx
    movl (%ecx,%edx,1), %esp      # esp = next-&gt;stack

    # 恢复新线程的寄存器（对于新线程，是 0）
    popl %edi
    popl %esi
    popl %ebp
    popl %ebx
    ret  # 返回到 sf-&gt;eip，即 switch_entry
</pre></td></tr></tbody></table></code></div></div>

<h3 id="3-switch_entry-执行"><span class="me-2">3. switch_entry() 执行</span><a href="#3-switch_entry-执行" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>switch_entry:
    # 丢弃 switch_threads() 的参数
    addl $8, %esp

    # 调用 thread_schedule_tail(prev)
    pushl %eax
    call thread_schedule_tail
    addl $4, %esp

    # ret 将返回到 ef-&gt;eip，即 kernel_thread
    ret
</pre></td></tr></tbody></table></code></div></div>

<h3 id="4-kernel_thread-执行"><span class="me-2">4. kernel_thread() 执行</span><a href="#4-kernel_thread-执行" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">kernel_thread</span> <span class="p">(</span><span class="n">thread_func</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">aux</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">function</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="n">intr_enable</span> <span class="p">();</span>       <span class="c1">// 开启中断</span>
  <span class="n">function</span> <span class="p">(</span><span class="n">aux</span><span class="p">);</span>       <span class="c1">// 执行用户指定的函数！</span>
  <span class="n">thread_exit</span> <span class="p">();</span>       <span class="c1">// 函数返回后退出线程</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="执行流程图"><span class="me-2">执行流程图</span><a href="#执行流程图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre>schedule()
    │
    ▼
switch_threads(cur, next)
    │
    │  保存 cur 的寄存器和栈指针
    │  恢复 next 的栈指针
    │  恢复 next 的寄存器 (全是 0)
    │
    ▼  ret (从 next 的栈弹出返回地址)
switch_entry  (sf-&gt;eip)
    │
    │  丢弃参数
    │  调用 thread_schedule_tail()
    │
    ▼  ret (从栈弹出返回地址)
kernel_thread  (ef-&gt;eip)
    │
    │  intr_enable()
    │  function(aux)   ← 执行用户函数！
    │
    ▼  thread_exit()
线程结束
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="为什么需要三层栈帧"><span class="me-2">为什么需要三层栈帧？</span><a href="#为什么需要三层栈帧" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="switch_threads_frame"><span class="me-2">switch_threads_frame</span><a href="#switch_threads_frame" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>作用</strong>：模拟 switch_threads() 被调用后的状态</p>

<p>新线程第一次被调度时，需要假装它之前调用过 switch_threads()：</p>
<ul>
  <li>有保存的寄存器（初始化为 0）</li>
  <li>有返回地址（指向 switch_entry）</li>
</ul>

<h3 id="switch_entry_frame"><span class="me-2">switch_entry_frame</span><a href="#switch_entry_frame" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>作用</strong>：提供 switch_entry 的返回地址</p>

<p>switch_entry 需要一个返回地址（指向 kernel_thread）。</p>

<h3 id="kernel_thread_frame"><span class="me-2">kernel_thread_frame</span><a href="#kernel_thread_frame" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>作用</strong>：为 kernel_thread() 提供参数</p>

<p>kernel_thread() 需要知道要执行的函数和参数。</p>

<hr />

<h2 id="thread_func-类型"><span class="me-2">thread_func 类型</span><a href="#thread_func-类型" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">typedef</span> <span class="kt">void</span> <span class="nf">thread_func</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">aux</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>线程函数的签名：</p>
<ul>
  <li>返回类型：void</li>
  <li>参数：一个 void 指针</li>
</ul>

<p><strong>使用示例</strong>：</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kt">void</span>
<span class="nf">my_thread_func</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">aux</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">aux</span><span class="p">;</span>
  <span class="n">printf</span> <span class="p">(</span><span class="s">"Thread received: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 创建线程</span>
<span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
<span class="n">thread_create</span> <span class="p">(</span><span class="s">"my-thread"</span><span class="p">,</span> <span class="n">PRI_DEFAULT</span><span class="p">,</span> <span class="n">my_thread_func</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="常见问题"><span class="me-2">常见问题</span><a href="#常见问题" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="q1-为什么-kf-eip-设置为-null"><span class="me-2">Q1: 为什么 kf-&gt;eip 设置为 NULL？</span><a href="#q1-为什么-kf-eip-设置为-null" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>答</strong>：这是 kernel_thread() 的”返回地址”。正常情况下，kernel_thread() 不会 return（它调用 thread_exit()）。设置为 NULL 是一个安全措施：如果意外 return，访问 NULL 会导致明显的错误。</p>

<h3 id="q2-新线程的栈指针为什么指向-switch_threads_frame"><span class="me-2">Q2: 新线程的栈指针为什么指向 switch_threads_frame？</span><a href="#q2-新线程的栈指针为什么指向-switch_threads_frame" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>答</strong>：因为新线程第一次被调度时，会从 switch_threads() 的末尾继续执行。此时栈上需要有：</p>
<ol>
  <li>保存的寄存器（供 popl 恢复）</li>
  <li>返回地址（供 ret 跳转）</li>
</ol>

<h3 id="q3-为什么-sf-ebp-设置为-0"><span class="me-2">Q3: 为什么 sf-&gt;ebp 设置为 0？</span><a href="#q3-为什么-sf-ebp-设置为-0" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>答</strong>：ebp=0 表示栈帧链的终点。调试器在回溯调用栈时，遇到 ebp=0 就知道到顶了。</p>

<h3 id="q4-thread_create-返回后新线程就开始运行了吗"><span class="me-2">Q4: thread_create() 返回后新线程就开始运行了吗？</span><a href="#q4-thread_create-返回后新线程就开始运行了吗" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>答</strong>：不一定。thread_create() 只是将新线程加入 ready_list。新线程什么时候运行取决于调度器。可能：</p>
<ol>
  <li>立即被调度（如果优先级更高）</li>
  <li>在下一个时间片</li>
  <li>当前线程主动 yield 后</li>
</ol>

<h3 id="q5-如何向线程函数传递多个参数"><span class="me-2">Q5: 如何向线程函数传递多个参数？</span><a href="#q5-如何向线程函数传递多个参数" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>答</strong>：将多个参数打包成一个结构体：</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">thread_args</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">b</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">my_func</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">aux</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">thread_args</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">aux</span><span class="p">;</span>
  <span class="c1">// 使用 args-&gt;a, args-&gt;b, args-&gt;str</span>
<span class="p">}</span>

<span class="c1">// 注意：args 必须在线程执行期间有效！</span>
<span class="k">struct</span> <span class="n">thread_args</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">"hello"</span><span class="p">};</span>
<span class="n">thread_create</span> <span class="p">(</span><span class="s">"test"</span><span class="p">,</span> <span class="n">PRI_DEFAULT</span><span class="p">,</span> <span class="n">my_func</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="q6-线程函数-return-后会发生什么"><span class="me-2">Q6: 线程函数 return 后会发生什么？</span><a href="#q6-线程函数-return-后会发生什么" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>答</strong>：kernel_thread() 会调用 thread_exit()：</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">kernel_thread</span> <span class="p">(</span><span class="n">thread_func</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">aux</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="n">function</span> <span class="p">(</span><span class="n">aux</span><span class="p">);</span>       <span class="c1">// 执行用户函数</span>
  <span class="n">thread_exit</span> <span class="p">();</span>       <span class="c1">// 用户函数返回后，退出线程</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>所以线程函数可以安全地 return，不需要显式调用 thread_exit()。</p>

<hr />

<h2 id="调试技巧"><span class="me-2">调试技巧</span><a href="#调试技巧" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="打印新线程信息"><span class="me-2">打印新线程信息</span><a href="#打印新线程信息" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="n">tid_t</span>
<span class="nf">thread_create</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">priority</span><span class="p">,</span>
               <span class="n">thread_func</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">aux</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="c1">// ... 原有代码 ...</span>
  
  <span class="n">printf</span> <span class="p">(</span><span class="s">"Created thread '%s' (tid=%d, priority=%d)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
          <span class="n">name</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">priority</span><span class="p">);</span>
  <span class="n">printf</span> <span class="p">(</span><span class="s">"  stack at %p, thread at %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">stack</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
  
  <span class="n">thread_unblock</span> <span class="p">(</span><span class="n">t</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">tid</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="使用-gdb-跟踪"><span class="me-2">使用 GDB 跟踪</span><a href="#使用-gdb-跟踪" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre># 在 thread_create 设置断点
b thread_create

# 运行后查看新线程的栈
print *t
print *kf
print *ef
print *sf

# 单步执行
n
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="练习思考"><span class="me-2">练习思考</span><a href="#练习思考" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<ol>
  <li>
    <p><strong>计算题</strong>：thread_create() 在栈上分配了多少字节？（kernel_thread_frame + switch_entry_frame + switch_threads_frame）</p>
  </li>
  <li>
    <p><strong>分析题</strong>：如果 palloc_get_page() 不使用 PAL_ZERO 标志，会有什么问题？</p>
  </li>
  <li>
    <p><strong>设计题</strong>：如果想让线程创建时就是 RUNNING 状态（立即执行），需要修改哪些代码？</p>
  </li>
  <li>
    <p><strong>调试题</strong>：如果新线程创建后立即崩溃，可能是什么原因？如何诊断？</p>
  </li>
  <li>
    <p><strong>扩展题</strong>：如何实现 <code class="language-plaintext highlighter-rouge">thread_create_suspended()</code>，创建一个不自动加入就绪队列的线程？</p>
  </li>
</ol>

<hr />

<h2 id="下一步"><span class="me-2">下一步</span><a href="#下一步" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>理解了线程创建后，下一篇文档将详细介绍<strong>线程调度</strong>，看看调度器是如何选择下一个运行的线程的。</p>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/%E6%8A%80%E6%9C%AF/">技术</a>,
          <a href="/categories/pintos/">Pintos</a>
      </div>
    

    <!-- tags -->
    
      <div class="post-tags">
        <i class="fa fa-tags fa-fw me-1"></i>
        
          <a
            href="/tags/os/"
            class="post-tag no-text-decoration"
          >OS</a>
        
          <a
            href="/tags/pintos/"
            class="post-tag no-text-decoration"
          >Pintos</a>
        
          <a
            href="/tags/%E7%BA%BF%E7%A8%8B/"
            class="post-tag no-text-decoration"
          >线程</a>
        
          <a
            href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"
            class="post-tag no-text-decoration"
          >内存管理</a>
        
      </div>
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          本文由作者按照 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         进行授权
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">分享</span>
  <span class="share-icons">
    
    
    

    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="分享链接"
      data-title-succeed="链接已复制！"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">最近更新</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pintos-thread-03-create/">Pintos 线程系统详解（三）：线程创建</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pintos-thread-04-schedule/">Pintos 线程系统详解（四）：线程调度</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pintos-thread-05-switch/">Pintos 线程系统详解（五）：上下文切换</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pintos-thread-06-block-unblock/">Pintos 线程系统详解（六）：阻塞与唤醒</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pintos-thread-07-semaphore/">Pintos 线程系统详解（七）：信号量</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">热门标签</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/os/">OS</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/pintos/">Pintos</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E6%B1%87%E7%BC%96/">汇编</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%BC%95%E5%AF%BC%E5%8A%A0%E8%BD%BD%E7%A8%8B%E5%BA%8F/">引导加载程序</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E7%BA%BF%E7%A8%8B/">线程</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%86%85%E6%A0%B8/">内核</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%90%8C%E6%AD%A5/">同步</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/c%E8%AF%AD%E8%A8%80/">C语言</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/gdt/">GDT</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/x86/">x86</a>
      
    </div>
  </section>


            </div>

            
              
              






  <div class="toc-border-cover z-3"></div>
  <section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4">
    <h2 class="panel-heading ps-3 pb-2 mb-0">文章内容</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->















  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">相关文章</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/pintos-thread-12-priority/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1769356800"
  data-df="YYYY/MM/DD"
  
>
  2026/01/26
</time>

              <h4 class="pt-0 my-2">Pintos 线程系统详解（十二）：优先级调度</h4>
              <div class="text-muted">
                <p>详细解析 Pintos 中优先级调度的实现，包括优先级捐赠机制。</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/pintos-thread-11-idle/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1769356800"
  data-df="YYYY/MM/DD"
  
>
  2026/01/26
</time>

              <h4 class="pt-0 my-2">Pintos 线程系统详解（十一）：空闲线程</h4>
              <div class="text-muted">
                <p>详细解析 Pintos 中空闲线程的实现，理解操作系统如何处理无任务可执行的情况。</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/pintos-thread-10-interrupt/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1769356800"
  data-df="YYYY/MM/DD"
  
>
  2026/01/26
</time>

              <h4 class="pt-0 my-2">Pintos 线程系统详解（十）：中断处理</h4>
              <div class="text-muted">
                <p>详细解析 Pintos 中中断系统与线程调度的关系，理解中断如何驱动线程切换。</p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/pintos-thread-02-lifecycle/"
      class="btn btn-outline-primary"
      aria-label="上一篇"
    >
      <p>Pintos 线程系统详解（二）：线程生命周期</p>
    </a>
  

  
    <a
      href="/posts/pintos-thread-04-schedule/"
      class="btn btn-outline-primary"
      aria-label="下一篇"
    >
      <p>Pintos 线程系统详解（四）：线程调度</p>
    </a>
  
</nav>

            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>©
    <time>2026</time>

    
      <a href="https://github.com/zxsheather">Zxsheather</a>.
    

    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。"
      >保留部分权利。</span>
    
  </p>

  <p>本站采用 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 主题 <a
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="v7.4.1"
        href="https://github.com/cotes2020/jekyll-theme-chirpy"
        target="_blank"
        rel="noopener"
      >Chirpy</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center d-none">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">热门标签</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/os/">OS</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/pintos/">Pintos</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E6%B1%87%E7%BC%96/">汇编</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%BC%95%E5%AF%BC%E5%8A%A0%E8%BD%BD%E7%A8%8B%E5%BA%8F/">引导加载程序</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E7%BA%BF%E7%A8%8B/">线程</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%86%85%E6%A0%B8/">内核</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%90%8C%E6%AD%A5/">同步</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/c%E8%AF%AD%E8%A8%80/">C语言</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/gdt/">GDT</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/x86/">x86</a>
      
    </div>
  </section>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">发现新版本的内容。</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      更新
    </button>
  </div>
</aside>

    

    <!-- Embedded scripts -->

    
      
      <!-- The comments switcher -->


    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  
  document.addEventListener('DOMContentLoaded', () => {
    SimpleJekyllSearch({
      searchInput: document.getElementById('search-input'),
      resultsContainer: document.getElementById('search-results'),
      json: '/assets/js/data/search.json',
      searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{content}</p>  </article>',
      noResultsText: '<p class="mt-5">搜索结果为空</p>',
      templateMiddleware: function(prop, value, template) {
        if (prop === 'categories') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
          }
        }

        if (prop === 'tags') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
          }
        }
      }
    });
  });
</script>

  </body>
</html>

