<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="zh-CN" >
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  ><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Pintos 线程系统详解（四）：线程调度" />
<meta property="og:locale" content="zh_CN" />
<meta name="description" content="详细解析 Pintos 中的线程调度机制，包括 schedule() 函数和调度算法。" />
<meta property="og:description" content="详细解析 Pintos 中的线程调度机制，包括 schedule() 函数和调度算法。" />
<link rel="canonical" href="http://localhost:4000/posts/pintos-thread-04-schedule/" />
<meta property="og:url" content="http://localhost:4000/posts/pintos-thread-04-schedule/" />
<meta property="og:site_name" content="Zxsheather" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2026-01-26T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Pintos 线程系统详解（四）：线程调度" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2026-01-26T00:00:00+08:00","datePublished":"2026-01-26T00:00:00+08:00","description":"详细解析 Pintos 中的线程调度机制，包括 schedule() 函数和调度算法。","headline":"Pintos 线程系统详解（四）：线程调度","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/pintos-thread-04-schedule/"},"url":"http://localhost:4000/posts/pintos-thread-04-schedule/"}</script>
<!-- End Jekyll SEO tag -->


  <title>Pintos 线程系统详解（四）：线程调度 | Zxsheather
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="icon" type="image/png" href="/assets/img/favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/svg+xml" href="/assets/img/favicons/favicon.svg">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">

  <link rel="manifest" href="/assets/img/favicons/site.webmanifest">



  <!-- Resource Hints -->
  
    
      
        <link rel="preconnect" href="https://fonts.googleapis.com" >
      
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
      
    
      
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" >
      
    
      
        <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      
        <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
      
    
  

  <!-- Bootstrap -->
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
  

  <!-- Theme style -->
  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  <!-- Web Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css">

  <!-- 3rd-party Dependencies -->

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.36.4/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Image Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css">
  

  <!-- Scripts -->

  <script src="/assets/js/dist/theme.min.js"></script>

  <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.18/dayjs.min.js,npm/dayjs@1.11.18/locale/zh.js,npm/dayjs@1.11.18/plugin/relativeTime.js,npm/dayjs@1.11.18/plugin/localizedFormat.js,npm/tocbot@4.36.4/dist/tocbot.min.js,npm/mermaid@11.12.0/dist/mermaid.min.js"></script>







<script defer src="/assets/js/dist/post.min.js"></script>



<!-- Pageviews -->

  

  



  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/3.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <a class="site-title d-block" href="/">Zxsheather</a>
    <p class="site-subtitle fst-italic mb-0">A CS Undergraduate</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>首页</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>分类</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>标签</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>归档</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>关于</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    
      <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle">
        <i class="fas fa-adjust"></i>
      </button>

      
    

    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">首页</a>
            </span>

          
        
          
        
          
            
              <span>Pintos 线程系统详解（四）：线程调度</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      文章
    </div>

    <button type="button" id="search-trigger" class="btn btn-link" aria-label="Search">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search id="search" class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="搜索..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">取消</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->





<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->










<article class="px-1" data-toc="true">
  <header>
    <h1 data-toc-skip>Pintos 线程系统详解（四）：线程调度</h1>
    
      <p class="post-desc fw-light mb-4">详细解析 Pintos 中的线程调度机制，包括 schedule() 函数和调度算法。</p>
    

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        发表于
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1769356800"
  data-df="YYYY/MM/DD"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  2026/01/26
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          作者

          <em>
            
              <a href="https://github.com/zxsheather">Zxsheather</a>
            
          </em>
        </span>

        <div>
          <!-- pageviews -->
          

          <!-- read time -->
          <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="3227 字"
>
  <em>17 分钟</em>阅读</span>

        </div>
      </div>
    </div>
  </header>

  
    <div id="toc-bar" class="d-flex align-items-center justify-content-between invisible">
      <span class="label text-truncate">Pintos 线程系统详解（四）：线程调度</span>
      <button type="button" class="toc-trigger btn me-1">
        <i class="fa-solid fa-list-ul fa-fw"></i>
      </button>
    </div>

    <button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm">
      <span class="label ps-2 pe-1">文章内容</span>
      <i class="fa-solid fa-angle-right fa-fw"></i>
    </button>

    <dialog id="toc-popup" class="p-0">
      <div class="header d-flex flex-row align-items-center justify-content-between">
        <div class="label text-truncate py-2 ms-4">Pintos 线程系统详解（四）：线程调度</div>
        <button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75">
          <i class="fas fa-close"></i>
        </button>
      </div>
      <div id="toc-popup-content" class="px-4 py-3 pb-4"></div>
    </dialog>
  

  <div class="content">
    <h2 id="概述"><span class="me-2">概述</span><a href="#概述" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>本文档详细解析 Pintos 中的线程调度机制。调度器（scheduler）是操作系统的核心组件，负责决定哪个线程获得 CPU 时间。Pintos 默认使用<strong>轮转调度（Round-Robin）</strong>算法。</p>

<hr />

<h2 id="原始代码"><span class="me-2">原始代码</span><a href="#原始代码" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="schedule-函数"><span class="me-2">schedule() 函数</span><a href="#schedule-函数" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="cm">/** Schedules a new process.  At entry, interrupts must be off and
   the running process's state must have been changed from
   running to some other state.  This function finds another
   thread to run and switches to it.

   It's not safe to call printf() until thread_schedule_tail()
   has completed. */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">schedule</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="n">running_thread</span> <span class="p">();</span>
  <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">next_thread_to_run</span> <span class="p">();</span>
  <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">intr_get_level</span> <span class="p">()</span> <span class="o">==</span> <span class="n">INTR_OFF</span><span class="p">);</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">THREAD_RUNNING</span><span class="p">);</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">is_thread</span> <span class="p">(</span><span class="n">next</span><span class="p">));</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">!=</span> <span class="n">next</span><span class="p">)</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="n">switch_threads</span> <span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
  <span class="n">thread_schedule_tail</span> <span class="p">(</span><span class="n">prev</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="next_thread_to_run-函数"><span class="me-2">next_thread_to_run() 函数</span><a href="#next_thread_to_run-函数" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="cm">/** Chooses and returns the next thread to be scheduled.  Should
   return a thread from the run queue, unless the run queue is
   empty.  (If the running thread can continue running, then it
   will be in the run queue.)  If the run queue is empty, return
   idle_thread. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span>
<span class="nf">next_thread_to_run</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ready_list</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">idle_thread</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">list_pop_front</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ready_list</span><span class="p">),</span> <span class="k">struct</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">elem</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="thread_schedule_tail-函数"><span class="me-2">thread_schedule_tail() 函数</span><a href="#thread_schedule_tail-函数" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="rouge-code"><pre><span class="cm">/** Completes a thread switch by activating the new thread's page
   tables, and, if the previous thread is dying, destroying it.

   At this function's invocation, we just switched from thread
   PREV, the new thread is already running, and interrupts are
   still disabled.  This function is normally invoked by
   thread_schedule() as its final action before returning, but
   the first time a thread is scheduled it is called by
   switch_entry() (see switch.S).

   It's not safe to call printf() until the thread switch is
   complete.  In practice that means that printf()s should be
   added at the end of the function.

   After this function and its caller returns, the thread switch
   is complete. */</span>
<span class="kt">void</span>
<span class="nf">thread_schedule_tail</span> <span class="p">(</span><span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">prev</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="n">running_thread</span> <span class="p">();</span>
  
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">intr_get_level</span> <span class="p">()</span> <span class="o">==</span> <span class="n">INTR_OFF</span><span class="p">);</span>

  <span class="cm">/* Mark us as running. */</span>
  <span class="n">cur</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">THREAD_RUNNING</span><span class="p">;</span>

  <span class="cm">/* Start new time slice. */</span>
  <span class="n">thread_ticks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef USERPROG
</span>  <span class="cm">/* Activate the new address space. */</span>
  <span class="n">process_activate</span> <span class="p">();</span>
<span class="cp">#endif
</span>
  <span class="cm">/* If the thread we switched from is dying, destroy its struct
     thread.  This must happen late so that thread_exit() doesn't
     pull out the rug under itself.  (We don't free
     initial_thread because its memory was not obtained via
     palloc().) */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">prev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">THREAD_DYING</span> <span class="o">&amp;&amp;</span> <span class="n">prev</span> <span class="o">!=</span> <span class="n">initial_thread</span><span class="p">)</span> 
    <span class="p">{</span>
      <span class="n">ASSERT</span> <span class="p">(</span><span class="n">prev</span> <span class="o">!=</span> <span class="n">cur</span><span class="p">);</span>
      <span class="n">palloc_free_page</span> <span class="p">(</span><span class="n">prev</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="thread_yield-函数"><span class="me-2">thread_yield() 函数</span><a href="#thread_yield-函数" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="cm">/** Yields the CPU.  The current thread is not put to sleep and
   may be scheduled again immediately at the scheduler's whim. */</span>
<span class="kt">void</span>
<span class="nf">thread_yield</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="n">thread_current</span> <span class="p">();</span>
  <span class="k">enum</span> <span class="n">intr_level</span> <span class="n">old_level</span><span class="p">;</span>
  
  <span class="n">ASSERT</span> <span class="p">(</span><span class="o">!</span><span class="n">intr_context</span> <span class="p">());</span>

  <span class="n">old_level</span> <span class="o">=</span> <span class="n">intr_disable</span> <span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">!=</span> <span class="n">idle_thread</span><span class="p">)</span> 
    <span class="n">list_push_back</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ready_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">);</span>
  <span class="n">cur</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">THREAD_READY</span><span class="p">;</span>
  <span class="n">schedule</span> <span class="p">();</span>
  <span class="n">intr_set_level</span> <span class="p">(</span><span class="n">old_level</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="thread_tick-函数"><span class="me-2">thread_tick() 函数</span><a href="#thread_tick-函数" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="cm">/** Called by the timer interrupt handler at each timer tick.
   Thus, this function runs in an external interrupt context. */</span>
<span class="kt">void</span>
<span class="nf">thread_tick</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">thread_current</span> <span class="p">();</span>

  <span class="cm">/* Update statistics. */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">idle_thread</span><span class="p">)</span>
    <span class="n">idle_ticks</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#ifdef USERPROG
</span>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">pagedir</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="n">user_ticks</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif
</span>  <span class="k">else</span>
    <span class="n">kernel_ticks</span><span class="o">++</span><span class="p">;</span>

  <span class="cm">/* Enforce preemption. */</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">thread_ticks</span> <span class="o">&gt;=</span> <span class="n">TIME_SLICE</span><span class="p">)</span>
    <span class="n">intr_yield_on_return</span> <span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="前置知识"><span class="me-2">前置知识</span><a href="#前置知识" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="1-调度的基本概念"><span class="me-2">1. 调度的基本概念</span><a href="#1-调度的基本概念" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>调度器的职责</strong>：</p>
<ul>
  <li>决定哪个线程运行</li>
  <li>决定运行多长时间</li>
  <li>实现公平性或其他策略</li>
</ul>

<p><strong>调度时机</strong>：</p>
<ul>
  <li>线程主动让出 CPU（yield）</li>
  <li>线程阻塞等待事件（block）</li>
  <li>线程时间片耗尽（抢占）</li>
  <li>线程退出（exit）</li>
</ul>

<h3 id="2-轮转调度round-robin"><span class="me-2">2. 轮转调度（Round-Robin）</span><a href="#2-轮转调度round-robin" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>最简单的调度算法：</p>
<ol>
  <li>所有就绪线程排成队列</li>
  <li>每个线程运行固定时间（时间片）</li>
  <li>时间片耗尽后，排到队尾</li>
  <li>下一个线程继续运行</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>就绪队列: [A] → [B] → [C] → (尾部)

时间片 1: A 运行，队列变为 [B] → [C] → [A]
时间片 2: B 运行，队列变为 [C] → [A] → [B]
时间片 3: C 运行，队列变为 [A] → [B] → [C]
... 循环 ...
</pre></td></tr></tbody></table></code></div></div>

<h3 id="3-时间片"><span class="me-2">3. 时间片</span><a href="#3-时间片" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="cp">#define TIME_SLICE 4  // 4 个 tick
</span></pre></td></tr></tbody></table></code></div></div>

<p>一个 tick 是定时器中断的周期，默认约 10ms。
所以一个时间片约 40ms。</p>

<hr />

<h2 id="schedule-函数详解"><span class="me-2">schedule() 函数详解</span><a href="#schedule-函数详解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="函数签名和断言"><span class="me-2">函数签名和断言</span><a href="#函数签名和断言" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">schedule</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="n">running_thread</span> <span class="p">();</span>
  <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">next_thread_to_run</span> <span class="p">();</span>
  <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">intr_get_level</span> <span class="p">()</span> <span class="o">==</span> <span class="n">INTR_OFF</span><span class="p">);</span>  <span class="c1">// 中断必须禁用</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">THREAD_RUNNING</span><span class="p">);</span>   <span class="c1">// 当前线程状态已改变</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">is_thread</span> <span class="p">(</span><span class="n">next</span><span class="p">));</span>                <span class="c1">// next 是有效线程</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>为什么中断必须禁用？</strong></p>

<p>调度涉及多个操作，必须原子执行：</p>
<ul>
  <li>修改 ready_list</li>
  <li>修改线程状态</li>
  <li>切换栈和寄存器</li>
</ul>

<p><strong>为什么 cur-&gt;status != THREAD_RUNNING？</strong></p>

<p>调用 schedule() 前，当前线程应该已经：</p>
<ul>
  <li>变为 READY（如果是 yield）</li>
  <li>变为 BLOCKED（如果是 block）</li>
  <li>变为 DYING（如果是 exit）</li>
</ul>

<h3 id="选择下一个线程"><span class="me-2">选择下一个线程</span><a href="#选择下一个线程" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>  <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">next_thread_to_run</span> <span class="p">();</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span>
<span class="nf">next_thread_to_run</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ready_list</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">idle_thread</span><span class="p">;</span>         <span class="c1">// 队列空，运行 idle</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">list_pop_front</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ready_list</span><span class="p">),</span> <span class="k">struct</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">elem</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>这就是轮转调度的核心：</p>
<ul>
  <li>从队首取出一个线程</li>
  <li>如果队列空，返回 idle_thread</li>
</ul>

<h3 id="执行上下文切换"><span class="me-2">执行上下文切换</span><a href="#执行上下文切换" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>  <span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">!=</span> <span class="n">next</span><span class="p">)</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="n">switch_threads</span> <span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>如果 cur == next</strong>：当前线程继续运行（例如只有一个线程时）。</p>

<p><strong>switch_threads()</strong>：在 switch.S 中实现，后面详细讲解。</p>

<h3 id="完成切换"><span class="me-2">完成切换</span><a href="#完成切换" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>  <span class="n">thread_schedule_tail</span> <span class="p">(</span><span class="n">prev</span><span class="p">);</span>
<span class="err">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>切换完成后的收尾工作，包括：</p>
<ul>
  <li>标记新线程为 RUNNING</li>
  <li>重置时间片计数</li>
  <li>释放 DYING 线程的内存</li>
</ul>

<hr />

<h2 id="next_thread_to_run-详解"><span class="me-2">next_thread_to_run() 详解</span><a href="#next_thread_to_run-详解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span>
<span class="nf">next_thread_to_run</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ready_list</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">idle_thread</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">list_pop_front</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ready_list</span><span class="p">),</span> <span class="k">struct</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">elem</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="list_pop_front-的作用"><span class="me-2">list_pop_front() 的作用</span><a href="#list_pop_front-的作用" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>从链表头部移除并返回元素：</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>调用前:
ready_list: [A] → [B] → [C]

调用后:
ready_list: [B] → [C]
返回值: 指向 A 的 elem 的指针
</pre></td></tr></tbody></table></code></div></div>

<h3 id="list_entry-宏"><span class="me-2">list_entry() 宏</span><a href="#list_entry-宏" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="cp">#define list_entry(LIST_ELEM, STRUCT, MEMBER) \
        ((STRUCT *) ((uint8_t *) (LIST_ELEM) - offsetof (STRUCT, MEMBER)))
</span></pre></td></tr></tbody></table></code></div></div>

<p>从 list_elem 指针获取包含它的结构体指针：</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c1">// elem 是 struct thread 中的成员</span>
<span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="k">struct</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">elem</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>工作原理</strong>：</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>struct thread
┌───────────────────┐ 0
│ tid               │
│ status            │
│ name[16]          │
│ stack             │
│ priority          │
│ allelem           │
├───────────────────┤ 40  ← elem 的偏移量 (假设)
│ elem.prev         │
│ elem.next         │
├───────────────────┤
│ ...               │
└───────────────────┘

如果知道 elem 的地址是 X，
那么 struct thread 的地址是 X - 40
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="thread_schedule_tail-详解"><span class="me-2">thread_schedule_tail() 详解</span><a href="#thread_schedule_tail-详解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="标记运行状态"><span class="me-2">标记运行状态</span><a href="#标记运行状态" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kt">void</span>
<span class="nf">thread_schedule_tail</span> <span class="p">(</span><span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">prev</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="n">running_thread</span> <span class="p">();</span>
  
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">intr_get_level</span> <span class="p">()</span> <span class="o">==</span> <span class="n">INTR_OFF</span><span class="p">);</span>

  <span class="cm">/* Mark us as running. */</span>
  <span class="n">cur</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">THREAD_RUNNING</span><span class="p">;</span>

  <span class="cm">/* Start new time slice. */</span>
  <span class="n">thread_ticks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>注意</strong>：此时 <code class="language-plaintext highlighter-rouge">running_thread()</code> 返回的是新线程，因为栈已经切换了。</p>

<h3 id="切换地址空间用户程序"><span class="me-2">切换地址空间（用户程序）</span><a href="#切换地址空间用户程序" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="cp">#ifdef USERPROG
</span>  <span class="cm">/* Activate the new address space. */</span>
  <span class="n">process_activate</span> <span class="p">();</span>
<span class="cp">#endif
</span></pre></td></tr></tbody></table></code></div></div>

<p>对于用户进程，需要切换页表。内核线程不需要。</p>

<h3 id="销毁-dying-线程"><span class="me-2">销毁 DYING 线程</span><a href="#销毁-dying-线程" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>  <span class="cm">/* If the thread we switched from is dying, destroy its struct thread. */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">prev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">THREAD_DYING</span> <span class="o">&amp;&amp;</span> <span class="n">prev</span> <span class="o">!=</span> <span class="n">initial_thread</span><span class="p">)</span> 
    <span class="p">{</span>
      <span class="n">ASSERT</span> <span class="p">(</span><span class="n">prev</span> <span class="o">!=</span> <span class="n">cur</span><span class="p">);</span>
      <span class="n">palloc_free_page</span> <span class="p">(</span><span class="n">prev</span><span class="p">);</span>
    <span class="p">}</span>
<span class="err">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>为什么由下一个线程来释放？</strong></p>

<p>因为 DYING 线程正在使用自己的栈，不能释放自己占用的内存。</p>

<p><strong>为什么不释放 initial_thread？</strong></p>

<p>initial_thread 的内存不是通过 palloc 分配的，而是由 loader.S 设置的。</p>

<hr />

<h2 id="thread_yield-详解"><span class="me-2">thread_yield() 详解</span><a href="#thread_yield-详解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kt">void</span>
<span class="nf">thread_yield</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="n">thread_current</span> <span class="p">();</span>
  <span class="k">enum</span> <span class="n">intr_level</span> <span class="n">old_level</span><span class="p">;</span>
  
  <span class="n">ASSERT</span> <span class="p">(</span><span class="o">!</span><span class="n">intr_context</span> <span class="p">());</span>  <span class="c1">// 不能在中断处理中调用</span>

  <span class="n">old_level</span> <span class="o">=</span> <span class="n">intr_disable</span> <span class="p">();</span>  <span class="c1">// 禁用中断</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">!=</span> <span class="n">idle_thread</span><span class="p">)</span> 
    <span class="n">list_push_back</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ready_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">);</span>  <span class="c1">// 加入队尾</span>
  <span class="n">cur</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">THREAD_READY</span><span class="p">;</span>
  <span class="n">schedule</span> <span class="p">();</span>                  <span class="c1">// 调度</span>
  
  <span class="n">intr_set_level</span> <span class="p">(</span><span class="n">old_level</span><span class="p">);</span>   <span class="c1">// 恢复中断（被调度回来后）</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="执行流程"><span class="me-2">执行流程</span><a href="#执行流程" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre>Thread A 调用 thread_yield()
        │
        ▼
    禁用中断
        │
        ▼
    A 加入 ready_list 队尾
        │
        ▼
    A.status = READY
        │
        ▼
    schedule()
        │
        ├───────────────────────┐
        │                       │
        ▼                       │
    切换到 Thread B             │
                                │
    ... B 运行一段时间 ...       │
                                │
    某时刻 B yield 或 block      │
        │                       │
        ▼                       │
    切换回 Thread A ◄───────────┘
        │
        ▼
    恢复中断
        │
        ▼
    thread_yield() 返回
</pre></td></tr></tbody></table></code></div></div>

<h3 id="为什么-idle_thread-不加入-ready_list"><span class="me-2">为什么 idle_thread 不加入 ready_list？</span><a href="#为什么-idle_thread-不加入-ready_list" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>idle_thread 是特殊的：</p>
<ul>
  <li>当且仅当 ready_list 为空时才运行</li>
  <li>永远不应该出现在 ready_list 中</li>
  <li>由 <code class="language-plaintext highlighter-rouge">next_thread_to_run()</code> 在需要时返回</li>
</ul>

<hr />

<h2 id="时间片和抢占"><span class="me-2">时间片和抢占</span><a href="#时间片和抢占" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="thread_tick---定时器中断处理"><span class="me-2">thread_tick() - 定时器中断处理</span><a href="#thread_tick---定时器中断处理" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kt">void</span>
<span class="nf">thread_tick</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">thread_current</span> <span class="p">();</span>

  <span class="cm">/* Update statistics. */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">idle_thread</span><span class="p">)</span>
    <span class="n">idle_ticks</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#ifdef USERPROG
</span>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">pagedir</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="n">user_ticks</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif
</span>  <span class="k">else</span>
    <span class="n">kernel_ticks</span><span class="o">++</span><span class="p">;</span>

  <span class="cm">/* Enforce preemption. */</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">thread_ticks</span> <span class="o">&gt;=</span> <span class="n">TIME_SLICE</span><span class="p">)</span>
    <span class="n">intr_yield_on_return</span> <span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="抢占机制"><span class="me-2">抢占机制</span><a href="#抢占机制" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="cp">#define TIME_SLICE 4  // 时间片 = 4 ticks
</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">thread_ticks</span><span class="p">;</span>  <span class="c1">// 当前线程已运行的 ticks</span>
</pre></td></tr></tbody></table></code></div></div>

<p>每次定时器中断（每 tick）：</p>
<ol>
  <li><code class="language-plaintext highlighter-rouge">thread_ticks++</code></li>
  <li>如果 <code class="language-plaintext highlighter-rouge">thread_ticks &gt;= TIME_SLICE</code>，设置抢占标志</li>
</ol>

<h3 id="intr_yield_on_return"><span class="me-2">intr_yield_on_return()</span><a href="#intr_yield_on_return" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kt">void</span>
<span class="nf">intr_yield_on_return</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">intr_context</span> <span class="p">());</span>  <span class="c1">// 必须在中断上下文中</span>
  <span class="n">yield_on_return</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>只是设置一个标志，不立即 yield。</p>

<h3 id="中断返回时检查"><span class="me-2">中断返回时检查</span><a href="#中断返回时检查" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>在 <code class="language-plaintext highlighter-rouge">intr_handler()</code> 末尾：</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kt">void</span>
<span class="nf">intr_handler</span> <span class="p">(</span><span class="k">struct</span> <span class="n">intr_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="c1">// ... 处理中断 ...</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">external</span><span class="p">)</span> 
    <span class="p">{</span>
      <span class="c1">// ...</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">yield_on_return</span><span class="p">)</span> 
        <span class="n">thread_yield</span> <span class="p">();</span>  <span class="c1">// 中断返回前 yield</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="调度流程图"><span class="me-2">调度流程图</span><a href="#调度流程图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="时间片耗尽的抢占流程"><span class="me-2">时间片耗尽的抢占流程</span><a href="#时间片耗尽的抢占流程" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre>时间 ──────────────────────────────────────────────────────►

Thread A 运行
┌─────────────────────────────────────────────────────────┐
│ tick 1 │ tick 2 │ tick 3 │ tick 4 │                     │
│        │        │        │   ↓    │                     │
│        │        │        │ 时间片耗尽                   │
│        │        │        │ intr_yield_on_return()      │
│        │        │        │   ↓                          │
│        │        │        │ thread_yield()              │
│        │        │        │   ↓                          │
│        │        │        │ schedule()                  │
└────────┴────────┴────────┴───┬──────────────────────────┘
                               │
                               ▼ 切换
Thread B 运行
┌─────────────────────────────────────────────────────────┐
│ tick 1 │ tick 2 │ tick 3 │ tick 4 │                     │
│        │        │        │   ...  │                     │
</pre></td></tr></tbody></table></code></div></div>

<h3 id="主动-yield-的流程"><span class="me-2">主动 yield 的流程</span><a href="#主动-yield-的流程" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre>Thread A                          Thread B
    │                                │
    │ thread_yield()                 │
    │     │                          │
    │     ├── 加入 ready_list        │
    │     │                          │
    │     ├── status = READY         │
    │     │                          │
    │     ├── schedule()             │
    │     │        │                 │
    │     │        ├── next = B      │
    │     │        │                 │
    │     │        ├── switch ───────┤
    │                                │
    │                                │ 开始运行
    │                                │
    │                                │ ... 一段时间后 ...
    │                                │
    │                                │ schedule() 切回 A
    │◄───────────────────────────────┤
    │     │                          │
    │     └── 恢复中断               │
    │                                │
    ▼                                │
  继续运行                           │
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="调度的原子性保证"><span class="me-2">调度的原子性保证</span><a href="#调度的原子性保证" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="为什么需要禁用中断"><span class="me-2">为什么需要禁用中断？</span><a href="#为什么需要禁用中断" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>调度涉及的操作必须不可分割：</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c1">// 危险的非原子操作示例（如果不禁用中断）：</span>
<span class="n">list_push_back</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ready_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">);</span>  <span class="c1">// 步骤 1</span>
<span class="c1">// 如果这里发生中断，调度器可能看到不一致的状态！</span>
<span class="n">cur</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">THREAD_READY</span><span class="p">;</span>                 <span class="c1">// 步骤 2</span>
<span class="n">schedule</span> <span class="p">();</span>                                <span class="c1">// 步骤 3</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="中断禁用的范围"><span class="me-2">中断禁用的范围</span><a href="#中断禁用的范围" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kt">void</span>
<span class="nf">thread_yield</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="n">old_level</span> <span class="o">=</span> <span class="n">intr_disable</span> <span class="p">();</span>   <span class="c1">// ← 禁用</span>
  <span class="c1">// ---------- 临界区 ----------</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">!=</span> <span class="n">idle_thread</span><span class="p">)</span> 
    <span class="n">list_push_back</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ready_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">);</span>
  <span class="n">cur</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">THREAD_READY</span><span class="p">;</span>
  <span class="n">schedule</span> <span class="p">();</span>
  <span class="c1">// ---------- 临界区 ----------</span>
  <span class="n">intr_set_level</span> <span class="p">(</span><span class="n">old_level</span><span class="p">);</span>    <span class="c1">// ← 恢复</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="调度器的数据结构"><span class="me-2">调度器的数据结构</span><a href="#调度器的数据结构" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="cm">/* 就绪队列 - FIFO */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">list</span> <span class="n">ready_list</span><span class="p">;</span>

<span class="cm">/* 时间片计数 */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">thread_ticks</span><span class="p">;</span>

<span class="cm">/* 时间片长度 */</span>
<span class="cp">#define TIME_SLICE 4
</span>
<span class="cm">/* 统计信息 */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">idle_ticks</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">kernel_ticks</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">user_ticks</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>ready_list 结构</strong>：</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>ready_list (双向链表)
┌──────────────────────────────────────────────────────┐
│                                                        │
│  head ◄──► Thread A ◄──► Thread B ◄──► Thread C ◄──► tail
│            (elem)        (elem)        (elem)          │
└──────────────────────────────────────────────────────┘
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="常见问题"><span class="me-2">常见问题</span><a href="#常见问题" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="q1-如果所有线程都阻塞了会怎样"><span class="me-2">Q1: 如果所有线程都阻塞了会怎样？</span><a href="#q1-如果所有线程都阻塞了会怎样" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>答</strong>：idle_thread 会运行。idle_thread 的工作是：</p>
<ol>
  <li>阻塞自己</li>
  <li>执行 <code class="language-plaintext highlighter-rouge">hlt</code> 指令等待中断</li>
  <li>中断发生后唤醒，然后继续阻塞</li>
</ol>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">idle</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">aux</span> <span class="n">UNUSED</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="k">for</span> <span class="p">(;;)</span> 
    <span class="p">{</span>
      <span class="n">intr_disable</span> <span class="p">();</span>
      <span class="n">thread_block</span> <span class="p">();</span>
      <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">"sti; hlt"</span> <span class="o">:</span> <span class="o">:</span> <span class="o">:</span> <span class="s">"memory"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="q2-schedule-为什么是-static-函数"><span class="me-2">Q2: schedule() 为什么是 static 函数？</span><a href="#q2-schedule-为什么是-static-函数" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>答</strong>：schedule() 是内部函数，只应该被以下函数调用：</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">thread_yield()</code></li>
  <li><code class="language-plaintext highlighter-rouge">thread_block()</code></li>
  <li><code class="language-plaintext highlighter-rouge">thread_exit()</code></li>
</ul>

<p>不应该直接从外部调用，因为调用前需要设置正确的状态。</p>

<h3 id="q3-为什么-thread_schedule_tail-是全局函数"><span class="me-2">Q3: 为什么 thread_schedule_tail() 是全局函数？</span><a href="#q3-为什么-thread_schedule_tail-是全局函数" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>答</strong>：因为 switch_entry() 需要调用它。switch_entry() 在 switch.S 中定义，需要一个全局符号。</p>

<h3 id="q4-线程优先级在当前实现中有效吗"><span class="me-2">Q4: 线程优先级在当前实现中有效吗？</span><a href="#q4-线程优先级在当前实现中有效吗" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>答</strong>：没有。当前实现只是 FIFO，不考虑优先级。实现优先级调度是 Project 1 的任务。</p>

<h3 id="q5-thread_ticks-在哪里重置"><span class="me-2">Q5: thread_ticks 在哪里重置？</span><a href="#q5-thread_ticks-在哪里重置" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>答</strong>：在 <code class="language-plaintext highlighter-rouge">thread_schedule_tail()</code> 中：</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">thread_ticks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// 新线程开始新的时间片</span>
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="练习思考"><span class="me-2">练习思考</span><a href="#练习思考" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<ol>
  <li>
    <p><strong>分析题</strong>：如果把 <code class="language-plaintext highlighter-rouge">list_push_back</code> 改成 <code class="language-plaintext highlighter-rouge">list_push_front</code>，对调度有什么影响？</p>
  </li>
  <li>
    <p><strong>设计题</strong>：如何实现基于优先级的调度？需要修改哪些函数？</p>
  </li>
  <li>
    <p><strong>计算题</strong>：假设有 3 个线程，时间片为 4 ticks，tick 周期为 10ms，每个线程运行完一轮需要多少时间？</p>
  </li>
  <li>
    <p><strong>调试题</strong>：如何验证轮转调度正在工作？（提示：打印日志）</p>
  </li>
  <li>
    <p><strong>扩展题</strong>：如何实现可变时间片？（不同优先级不同时间片长度）</p>
  </li>
</ol>

<hr />

<h2 id="下一步"><span class="me-2">下一步</span><a href="#下一步" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>理解了调度机制后，下一篇文档将深入 <strong>switch.S</strong> 汇编代码，看看上下文切换是如何在底层实现的。</p>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/%E6%8A%80%E6%9C%AF/">技术</a>,
          <a href="/categories/pintos/">Pintos</a>
      </div>
    

    <!-- tags -->
    
      <div class="post-tags">
        <i class="fa fa-tags fa-fw me-1"></i>
        
          <a
            href="/tags/os/"
            class="post-tag no-text-decoration"
          >OS</a>
        
          <a
            href="/tags/pintos/"
            class="post-tag no-text-decoration"
          >Pintos</a>
        
          <a
            href="/tags/%E7%BA%BF%E7%A8%8B/"
            class="post-tag no-text-decoration"
          >线程</a>
        
          <a
            href="/tags/%E8%B0%83%E5%BA%A6/"
            class="post-tag no-text-decoration"
          >调度</a>
        
      </div>
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          本文由作者按照 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         进行授权
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">分享</span>
  <span class="share-icons">
    
    
    

    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="分享链接"
      data-title-succeed="链接已复制！"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">最近更新</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pintos-thread-03-create/">Pintos 线程系统详解（三）：线程创建</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pintos-thread-04-schedule/">Pintos 线程系统详解（四）：线程调度</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pintos-thread-05-switch/">Pintos 线程系统详解（五）：上下文切换</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pintos-thread-06-block-unblock/">Pintos 线程系统详解（六）：阻塞与唤醒</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pintos-thread-07-semaphore/">Pintos 线程系统详解（七）：信号量</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">热门标签</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/os/">OS</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/pintos/">Pintos</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E6%B1%87%E7%BC%96/">汇编</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%BC%95%E5%AF%BC%E5%8A%A0%E8%BD%BD%E7%A8%8B%E5%BA%8F/">引导加载程序</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E7%BA%BF%E7%A8%8B/">线程</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%86%85%E6%A0%B8/">内核</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%90%8C%E6%AD%A5/">同步</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/c%E8%AF%AD%E8%A8%80/">C语言</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/gdt/">GDT</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/x86/">x86</a>
      
    </div>
  </section>


            </div>

            
              
              






  <div class="toc-border-cover z-3"></div>
  <section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4">
    <h2 class="panel-heading ps-3 pb-2 mb-0">文章内容</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->















  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">相关文章</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/pintos-thread-12-priority/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1769356800"
  data-df="YYYY/MM/DD"
  
>
  2026/01/26
</time>

              <h4 class="pt-0 my-2">Pintos 线程系统详解（十二）：优先级调度</h4>
              <div class="text-muted">
                <p>详细解析 Pintos 中优先级调度的实现，包括优先级捐赠机制。</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/pintos-thread-11-idle/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1769356800"
  data-df="YYYY/MM/DD"
  
>
  2026/01/26
</time>

              <h4 class="pt-0 my-2">Pintos 线程系统详解（十一）：空闲线程</h4>
              <div class="text-muted">
                <p>详细解析 Pintos 中空闲线程的实现，理解操作系统如何处理无任务可执行的情况。</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/pintos-thread-10-interrupt/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1769356800"
  data-df="YYYY/MM/DD"
  
>
  2026/01/26
</time>

              <h4 class="pt-0 my-2">Pintos 线程系统详解（十）：中断处理</h4>
              <div class="text-muted">
                <p>详细解析 Pintos 中中断系统与线程调度的关系，理解中断如何驱动线程切换。</p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/pintos-thread-03-create/"
      class="btn btn-outline-primary"
      aria-label="上一篇"
    >
      <p>Pintos 线程系统详解（三）：线程创建</p>
    </a>
  

  
    <a
      href="/posts/pintos-thread-05-switch/"
      class="btn btn-outline-primary"
      aria-label="下一篇"
    >
      <p>Pintos 线程系统详解（五）：上下文切换</p>
    </a>
  
</nav>

            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>©
    <time>2026</time>

    
      <a href="https://github.com/zxsheather">Zxsheather</a>.
    

    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。"
      >保留部分权利。</span>
    
  </p>

  <p>本站采用 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 主题 <a
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="v7.4.1"
        href="https://github.com/cotes2020/jekyll-theme-chirpy"
        target="_blank"
        rel="noopener"
      >Chirpy</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center d-none">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">热门标签</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/os/">OS</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/pintos/">Pintos</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E6%B1%87%E7%BC%96/">汇编</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%BC%95%E5%AF%BC%E5%8A%A0%E8%BD%BD%E7%A8%8B%E5%BA%8F/">引导加载程序</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E7%BA%BF%E7%A8%8B/">线程</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%86%85%E6%A0%B8/">内核</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%90%8C%E6%AD%A5/">同步</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/c%E8%AF%AD%E8%A8%80/">C语言</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/gdt/">GDT</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/x86/">x86</a>
      
    </div>
  </section>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">发现新版本的内容。</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      更新
    </button>
  </div>
</aside>

    

    <!-- Embedded scripts -->

    
      
      <!-- The comments switcher -->


    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  
  document.addEventListener('DOMContentLoaded', () => {
    SimpleJekyllSearch({
      searchInput: document.getElementById('search-input'),
      resultsContainer: document.getElementById('search-results'),
      json: '/assets/js/data/search.json',
      searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{content}</p>  </article>',
      noResultsText: '<p class="mt-5">搜索结果为空</p>',
      templateMiddleware: function(prop, value, template) {
        if (prop === 'categories') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
          }
        }

        if (prop === 'tags') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
          }
        }
      }
    });
  });
</script>

  </body>
</html>

