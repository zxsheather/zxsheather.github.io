<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="zh-CN" >
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  ><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Pintos 线程系统详解（九）：条件变量" />
<meta property="og:locale" content="zh_CN" />
<meta name="description" content="详细解析 Pintos 中条件变量（Condition Variable）的实现，理解高级同步机制。" />
<meta property="og:description" content="详细解析 Pintos 中条件变量（Condition Variable）的实现，理解高级同步机制。" />
<link rel="canonical" href="http://localhost:4000/posts/pintos-thread-09-condition/" />
<meta property="og:url" content="http://localhost:4000/posts/pintos-thread-09-condition/" />
<meta property="og:site_name" content="Zxsheather" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2026-01-26T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Pintos 线程系统详解（九）：条件变量" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2026-01-26T00:00:00+08:00","datePublished":"2026-01-26T00:00:00+08:00","description":"详细解析 Pintos 中条件变量（Condition Variable）的实现，理解高级同步机制。","headline":"Pintos 线程系统详解（九）：条件变量","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/pintos-thread-09-condition/"},"url":"http://localhost:4000/posts/pintos-thread-09-condition/"}</script>
<!-- End Jekyll SEO tag -->


  <title>Pintos 线程系统详解（九）：条件变量 | Zxsheather
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="icon" type="image/png" href="/assets/img/favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/svg+xml" href="/assets/img/favicons/favicon.svg">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">

  <link rel="manifest" href="/assets/img/favicons/site.webmanifest">



  <!-- Resource Hints -->
  
    
      
        <link rel="preconnect" href="https://fonts.googleapis.com" >
      
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
      
    
      
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" >
      
    
      
        <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      
        <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
      
    
  

  <!-- Bootstrap -->
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
  

  <!-- Theme style -->
  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  <!-- Web Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css">

  <!-- 3rd-party Dependencies -->

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.36.4/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Image Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css">
  

  <!-- Scripts -->

  <script src="/assets/js/dist/theme.min.js"></script>

  <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.18/dayjs.min.js,npm/dayjs@1.11.18/locale/zh.js,npm/dayjs@1.11.18/plugin/relativeTime.js,npm/dayjs@1.11.18/plugin/localizedFormat.js,npm/tocbot@4.36.4/dist/tocbot.min.js,npm/mermaid@11.12.0/dist/mermaid.min.js"></script>







<script defer src="/assets/js/dist/post.min.js"></script>



<!-- Pageviews -->

  

  



  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/3.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <a class="site-title d-block" href="/">Zxsheather</a>
    <p class="site-subtitle fst-italic mb-0">A CS Undergraduate</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>首页</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>分类</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>标签</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>归档</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>关于</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    
      <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle">
        <i class="fas fa-adjust"></i>
      </button>

      
    

    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">首页</a>
            </span>

          
        
          
        
          
            
              <span>Pintos 线程系统详解（九）：条件变量</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      文章
    </div>

    <button type="button" id="search-trigger" class="btn btn-link" aria-label="Search">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search id="search" class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="搜索..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">取消</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->





<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->










<article class="px-1" data-toc="true">
  <header>
    <h1 data-toc-skip>Pintos 线程系统详解（九）：条件变量</h1>
    
      <p class="post-desc fw-light mb-4">详细解析 Pintos 中条件变量（Condition Variable）的实现，理解高级同步机制。</p>
    

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        发表于
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1769356800"
  data-df="YYYY/MM/DD"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  2026/01/26
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          作者

          <em>
            
              <a href="https://github.com/zxsheather">Zxsheather</a>
            
          </em>
        </span>

        <div>
          <!-- pageviews -->
          

          <!-- read time -->
          <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="3059 字"
>
  <em>16 分钟</em>阅读</span>

        </div>
      </div>
    </div>
  </header>

  
    <div id="toc-bar" class="d-flex align-items-center justify-content-between invisible">
      <span class="label text-truncate">Pintos 线程系统详解（九）：条件变量</span>
      <button type="button" class="toc-trigger btn me-1">
        <i class="fa-solid fa-list-ul fa-fw"></i>
      </button>
    </div>

    <button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm">
      <span class="label ps-2 pe-1">文章内容</span>
      <i class="fa-solid fa-angle-right fa-fw"></i>
    </button>

    <dialog id="toc-popup" class="p-0">
      <div class="header d-flex flex-row align-items-center justify-content-between">
        <div class="label text-truncate py-2 ms-4">Pintos 线程系统详解（九）：条件变量</div>
        <button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75">
          <i class="fas fa-close"></i>
        </button>
      </div>
      <div id="toc-popup-content" class="px-4 py-3 pb-4"></div>
    </dialog>
  

  <div class="content">
    <h2 id="概述"><span class="me-2">概述</span><a href="#概述" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>本文档详细解析 Pintos 中<strong>条件变量（Condition Variable）</strong>的实现。条件变量允许线程等待特定条件成立，是实现复杂同步场景的重要工具。</p>

<p>条件变量必须与锁配合使用，用于：</p>
<ul>
  <li>等待某个条件变为真</li>
  <li>通知条件已改变</li>
</ul>

<hr />

<h2 id="原始代码"><span class="me-2">原始代码</span><a href="#原始代码" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="synchh-中的定义"><span class="me-2">synch.h 中的定义</span><a href="#synchh-中的定义" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="cm">/** Condition variable. */</span>
<span class="k">struct</span> <span class="n">condition</span> 
  <span class="p">{</span>
    <span class="k">struct</span> <span class="n">list</span> <span class="n">waiters</span><span class="p">;</span>        <span class="cm">/**&lt; List of waiting threads. */</span>
  <span class="p">};</span>

<span class="kt">void</span> <span class="nf">cond_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">condition</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">cond_wait</span> <span class="p">(</span><span class="k">struct</span> <span class="n">condition</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">cond_signal</span> <span class="p">(</span><span class="k">struct</span> <span class="n">condition</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">cond_broadcast</span> <span class="p">(</span><span class="k">struct</span> <span class="n">condition</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="synchc-中的实现"><span class="me-2">synch.c 中的实现</span><a href="#synchc-中的实现" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
</pre></td><td class="rouge-code"><pre><span class="cm">/** One semaphore in a list. */</span>
<span class="k">struct</span> <span class="n">semaphore_elem</span> 
  <span class="p">{</span>
    <span class="k">struct</span> <span class="n">list_elem</span> <span class="n">elem</span><span class="p">;</span>              <span class="cm">/**&lt; List element. */</span>
    <span class="k">struct</span> <span class="n">semaphore</span> <span class="n">semaphore</span><span class="p">;</span>         <span class="cm">/**&lt; This semaphore. */</span>
  <span class="p">};</span>

<span class="cm">/** Initializes condition variable COND.  A condition variable
   allows one piece of code to signal a condition and cooperating
   code to receive the signal and act upon it. */</span>
<span class="kt">void</span>
<span class="nf">cond_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">condition</span> <span class="o">*</span><span class="n">cond</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">cond</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="n">list_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">waiters</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/** Atomically releases LOCK and waits for COND to be signaled by
   some other piece of code.  After COND is signaled, LOCK is
   reacquired before returning.  LOCK must be held before calling
   this function.

   The monitor implemented by this function is "Mesa" style, not
   "Hoare" style, that is, sending and receiving a signal are not
   an atomic operation.  Thus, typically the caller must recheck
   the condition after the wait completes and, if necessary, wait
   again.

   A given condition variable is associated with only a single
   lock, but one lock may be associated with any number of
   condition variables.  That is, there is a one-to-many mapping
   from locks to condition variables.

   This function may sleep, so it must not be called within an
   interrupt handler.  This function may be called with
   interrupts disabled, but interrupts will be turned back on if
   we need to sleep. */</span>
<span class="kt">void</span>
<span class="nf">cond_wait</span> <span class="p">(</span><span class="k">struct</span> <span class="n">condition</span> <span class="o">*</span><span class="n">cond</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">semaphore_elem</span> <span class="n">waiter</span><span class="p">;</span>

  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">cond</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">lock</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="o">!</span><span class="n">intr_context</span> <span class="p">());</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">lock_held_by_current_thread</span> <span class="p">(</span><span class="n">lock</span><span class="p">));</span>
  
  <span class="n">sema_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">waiter</span><span class="p">.</span><span class="n">semaphore</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">list_push_back</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">waiters</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">waiter</span><span class="p">.</span><span class="n">elem</span><span class="p">);</span>
  <span class="n">lock_release</span> <span class="p">(</span><span class="n">lock</span><span class="p">);</span>
  <span class="n">sema_down</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">waiter</span><span class="p">.</span><span class="n">semaphore</span><span class="p">);</span>
  <span class="n">lock_acquire</span> <span class="p">(</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/** If any threads are waiting on COND (protected by LOCK), then
   this function signals one of them to wake up from its wait.
   LOCK must be held before calling this function.

   An interrupt handler cannot acquire a lock, so it does not
   make sense to try to signal a condition variable within an
   interrupt handler. */</span>
<span class="kt">void</span>
<span class="nf">cond_signal</span> <span class="p">(</span><span class="k">struct</span> <span class="n">condition</span> <span class="o">*</span><span class="n">cond</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="n">lock</span> <span class="n">UNUSED</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">cond</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">lock</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="o">!</span><span class="n">intr_context</span> <span class="p">());</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">lock_held_by_current_thread</span> <span class="p">(</span><span class="n">lock</span><span class="p">));</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">waiters</span><span class="p">))</span> 
    <span class="n">sema_up</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">list_entry</span> <span class="p">(</span><span class="n">list_pop_front</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">waiters</span><span class="p">),</span>
                          <span class="k">struct</span> <span class="n">semaphore_elem</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">semaphore</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/** Wakes up all threads, if any, waiting on COND (protected by
   LOCK).  LOCK must be held before calling this function.

   An interrupt handler cannot acquire a lock, so it does not
   make sense to try to signal a condition variable within an
   interrupt handler. */</span>
<span class="kt">void</span>
<span class="nf">cond_broadcast</span> <span class="p">(</span><span class="k">struct</span> <span class="n">condition</span> <span class="o">*</span><span class="n">cond</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">cond</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">lock</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">waiters</span><span class="p">))</span>
    <span class="n">cond_signal</span> <span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="前置知识"><span class="me-2">前置知识</span><a href="#前置知识" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="1-为什么需要条件变量"><span class="me-2">1. 为什么需要条件变量？</span><a href="#1-为什么需要条件变量" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>考虑一个生产者-消费者场景：</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="c1">// 消费者 - 不好的实现（忙等待）</span>
<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">lock_acquire</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">buffer_lock</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">buffer_is_empty</span> <span class="p">())</span> <span class="p">{</span>
    <span class="n">lock_release</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">buffer_lock</span><span class="p">);</span>
    <span class="n">thread_yield</span> <span class="p">();</span>              <span class="c1">// 忙等待！</span>
    <span class="n">lock_acquire</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">buffer_lock</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">consume</span> <span class="p">(</span><span class="n">buffer_get</span> <span class="p">());</span>
  <span class="n">lock_release</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">buffer_lock</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>问题</strong>：即使缓冲区为空，消费者也在不断检查，浪费 CPU。</p>

<p><strong>条件变量的解决方案</strong>：</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c1">// 消费者 - 好的实现</span>
<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">lock_acquire</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">buffer_lock</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">buffer_is_empty</span> <span class="p">())</span> <span class="p">{</span>
    <span class="n">cond_wait</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">not_empty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer_lock</span><span class="p">);</span>  <span class="c1">// 高效等待</span>
  <span class="p">}</span>
  <span class="n">consume</span> <span class="p">(</span><span class="n">buffer_get</span> <span class="p">());</span>
  <span class="n">lock_release</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">buffer_lock</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="2-monitor管程概念"><span class="me-2">2. Monitor（管程）概念</span><a href="#2-monitor管程概念" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>Monitor</strong> 是一种同步机制，包含：</p>
<ul>
  <li><strong>锁</strong>：保护共享数据</li>
  <li><strong>条件变量</strong>：等待/通知机制</li>
  <li><strong>共享数据</strong></li>
</ul>

<p>Pintos 的条件变量实现了 <strong>Mesa 风格</strong>的管程：</p>
<ul>
  <li>signal 只是唤醒等待者，不会立即切换</li>
  <li>等待者被唤醒后需要重新检查条件</li>
</ul>

<h3 id="3-mesa-vs-hoare-风格"><span class="me-2">3. Mesa vs Hoare 风格</span><a href="#3-mesa-vs-hoare-风格" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th>特性</th>
      <th>Mesa 风格</th>
      <th>Hoare 风格</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>signal 后</td>
      <td>继续执行</td>
      <td>立即切换到等待者</td>
    </tr>
    <tr>
      <td>wait 后</td>
      <td>需要重新检查条件</td>
      <td>条件保证为真</td>
    </tr>
    <tr>
      <td>实现复杂度</td>
      <td>简单</td>
      <td>复杂</td>
    </tr>
    <tr>
      <td>Pintos 使用</td>
      <td>✓</td>
      <td> </td>
    </tr>
  </tbody>
</table></div>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c1">// Mesa 风格必须用 while</span>
<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">condition</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cond_wait</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Hoare 风格可以用 if（但通常也用 while 更安全）</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">condition</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cond_wait</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="struct-condition-详解"><span class="me-2">struct condition 详解</span><a href="#struct-condition-详解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">condition</span> 
  <span class="p">{</span>
    <span class="k">struct</span> <span class="n">list</span> <span class="n">waiters</span><span class="p">;</span>        <span class="cm">/**&lt; List of waiting threads. */</span>
  <span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>

<p>非常简单：只有一个等待者列表。</p>

<p>但等待者不是直接的线程，而是 <code class="language-plaintext highlighter-rouge">semaphore_elem</code>：</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">semaphore_elem</span> 
  <span class="p">{</span>
    <span class="k">struct</span> <span class="n">list_elem</span> <span class="n">elem</span><span class="p">;</span>              <span class="cm">/**&lt; List element. */</span>
    <span class="k">struct</span> <span class="n">semaphore</span> <span class="n">semaphore</span><span class="p">;</span>         <span class="cm">/**&lt; This semaphore. */</span>
  <span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>为什么用信号量而不是直接用线程？</strong></p>

<p>每个等待者都有自己的信号量，这样可以：</p>
<ol>
  <li>精确唤醒特定等待者</li>
  <li>等待者可以自己的速度运行</li>
</ol>

<hr />

<h2 id="cond_init-详解"><span class="me-2">cond_init() 详解</span><a href="#cond_init-详解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kt">void</span>
<span class="nf">cond_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">condition</span> <span class="o">*</span><span class="n">cond</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">cond</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="n">list_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">waiters</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>初始化条件变量：只需初始化等待者列表。</p>

<hr />

<h2 id="cond_wait-详解"><span class="me-2">cond_wait() 详解</span><a href="#cond_wait-详解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>这是最复杂的函数：</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="kt">void</span>
<span class="nf">cond_wait</span> <span class="p">(</span><span class="k">struct</span> <span class="n">condition</span> <span class="o">*</span><span class="n">cond</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">semaphore_elem</span> <span class="n">waiter</span><span class="p">;</span>

  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">cond</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">lock</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="o">!</span><span class="n">intr_context</span> <span class="p">());</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">lock_held_by_current_thread</span> <span class="p">(</span><span class="n">lock</span><span class="p">));</span>  <span class="c1">// 必须持有锁</span>
  
  <span class="n">sema_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">waiter</span><span class="p">.</span><span class="n">semaphore</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>             <span class="c1">// 初始化信号量为 0</span>
  <span class="n">list_push_back</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">waiters</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">waiter</span><span class="p">.</span><span class="n">elem</span><span class="p">);</span> <span class="c1">// 加入等待队列</span>
  <span class="n">lock_release</span> <span class="p">(</span><span class="n">lock</span><span class="p">);</span>                           <span class="c1">// 释放锁</span>
  <span class="n">sema_down</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">waiter</span><span class="p">.</span><span class="n">semaphore</span><span class="p">);</span>                <span class="c1">// 等待（阻塞）</span>
  <span class="n">lock_acquire</span> <span class="p">(</span><span class="n">lock</span><span class="p">);</span>                           <span class="c1">// 被唤醒后重新获取锁</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="执行流程"><span class="me-2">执行流程</span><a href="#执行流程" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre>线程 A 调用 cond_wait(&amp;cond, &amp;lock)
         │
         ▼
    检查断言（必须持有锁）
         │
         ▼
    创建 semaphore_elem waiter
    sema_init(&amp;waiter.semaphore, 0)
         │
         ▼
    加入 cond-&gt;waiters 队列
         │
         ▼
    lock_release(lock)     ← 释放锁！
         │
         ▼
    sema_down(&amp;waiter.semaphore)  ← 阻塞等待
         │
         │ (其他线程调用 cond_signal)
         │
         ▼
    lock_acquire(lock)     ← 重新获取锁
         │
         ▼
      返回
</pre></td></tr></tbody></table></code></div></div>

<h3 id="关键点"><span class="me-2">关键点</span><a href="#关键点" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ol>
  <li><strong>必须持有锁</strong>：在检查条件和等待之间需要原子性</li>
  <li><strong>释放锁再等待</strong>：否则其他线程无法修改条件</li>
  <li><strong>被唤醒后重新获取锁</strong>：保持调用前后锁的状态一致</li>
</ol>

<h3 id="为什么用局部变量-waiter"><span class="me-2">为什么用局部变量 waiter？</span><a href="#为什么用局部变量-waiter" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><code class="language-plaintext highlighter-rouge">waiter</code> 在栈上分配，当函数返回时自动销毁。这是安全的，因为：</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">cond_wait</code> 返回时，<code class="language-plaintext highlighter-rouge">waiter</code> 已经被移出队列（由 <code class="language-plaintext highlighter-rouge">cond_signal</code> 的 <code class="language-plaintext highlighter-rouge">list_pop_front</code>）</li>
  <li>函数返回前，不再需要 <code class="language-plaintext highlighter-rouge">waiter</code></li>
</ul>

<hr />

<h2 id="cond_signal-详解"><span class="me-2">cond_signal() 详解</span><a href="#cond_signal-详解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kt">void</span>
<span class="nf">cond_signal</span> <span class="p">(</span><span class="k">struct</span> <span class="n">condition</span> <span class="o">*</span><span class="n">cond</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="n">lock</span> <span class="n">UNUSED</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">cond</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">lock</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="o">!</span><span class="n">intr_context</span> <span class="p">());</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">lock_held_by_current_thread</span> <span class="p">(</span><span class="n">lock</span><span class="p">));</span>  <span class="c1">// 必须持有锁</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">waiters</span><span class="p">))</span> 
    <span class="n">sema_up</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">list_entry</span> <span class="p">(</span><span class="n">list_pop_front</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">waiters</span><span class="p">),</span>
                          <span class="k">struct</span> <span class="n">semaphore_elem</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">semaphore</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="执行流程-1"><span class="me-2">执行流程</span><a href="#执行流程-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre>线程 B 调用 cond_signal(&amp;cond, &amp;lock)
         │
         ▼
    检查断言（必须持有锁）
         │
         ▼
    waiters 空?  ────► 是 ────► 什么都不做
         │
         │ 否
         │
         ▼
    取出队首的 semaphore_elem
         │
         ▼
    sema_up(&amp;elem-&gt;semaphore)
         │
         ▼
      返回
</pre></td></tr></tbody></table></code></div></div>

<h3 id="关键点-1"><span class="me-2">关键点</span><a href="#关键点-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ol>
  <li><strong>只唤醒一个</strong>：使用 <code class="language-plaintext highlighter-rouge">list_pop_front</code></li>
  <li><strong>FIFO 顺序</strong>：先等待的先被唤醒</li>
  <li><strong>可能无人等待</strong>：<code class="language-plaintext highlighter-rouge">waiters</code> 可能为空</li>
</ol>

<hr />

<h2 id="cond_broadcast-详解"><span class="me-2">cond_broadcast() 详解</span><a href="#cond_broadcast-详解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kt">void</span>
<span class="nf">cond_broadcast</span> <span class="p">(</span><span class="k">struct</span> <span class="n">condition</span> <span class="o">*</span><span class="n">cond</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">cond</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">ASSERT</span> <span class="p">(</span><span class="n">lock</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">waiters</span><span class="p">))</span>
    <span class="n">cond_signal</span> <span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>唤醒所有等待者。简单地重复调用 <code class="language-plaintext highlighter-rouge">cond_signal</code>。</p>

<p><strong>使用场景</strong>：</p>
<ul>
  <li>当条件改变可能影响多个等待者时</li>
  <li>当不知道哪个等待者应该被唤醒时</li>
</ul>

<hr />

<h2 id="条件变量的使用模式"><span class="me-2">条件变量的使用模式</span><a href="#条件变量的使用模式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="1-等待条件模式"><span class="me-2">1. 等待条件模式</span><a href="#1-等待条件模式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="n">lock_acquire</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">condition</span><span class="p">)</span> <span class="p">{</span>           <span class="c1">// 用 while，不用 if</span>
  <span class="n">cond_wait</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// 条件现在为真</span>
<span class="n">do_something</span> <span class="p">();</span>
<span class="n">lock_release</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="2-通知模式"><span class="me-2">2. 通知模式</span><a href="#2-通知模式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">lock_acquire</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<span class="n">change_condition</span> <span class="p">();</span>           <span class="c1">// 修改条件</span>
<span class="n">cond_signal</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>    <span class="c1">// 通知等待者</span>
<span class="c1">// 或 cond_broadcast (&amp;cond, &amp;lock);</span>
<span class="n">lock_release</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="3-生产者-消费者完整示例"><span class="me-2">3. 生产者-消费者完整示例</span><a href="#3-生产者-消费者完整示例" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">buffer</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">lock</span> <span class="n">lock</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">condition</span> <span class="n">not_empty</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">condition</span> <span class="n">not_full</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">items</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">in</span><span class="p">,</span> <span class="n">out</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span>
<span class="nf">buffer_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">buffer</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">lock_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
  <span class="n">cond_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">not_empty</span><span class="p">);</span>
  <span class="n">cond_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">not_full</span><span class="p">);</span>
  <span class="n">b</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">b</span><span class="o">-&gt;</span><span class="n">in</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">producer</span> <span class="p">(</span><span class="k">struct</span> <span class="n">buffer</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">lock_acquire</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
  
  <span class="k">while</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="n">BUFFER_SIZE</span><span class="p">)</span>
    <span class="n">cond_wait</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">not_full</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>  <span class="c1">// 等待有空位</span>
  
  <span class="n">b</span><span class="o">-&gt;</span><span class="n">items</span><span class="p">[</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">;</span>
  <span class="n">b</span><span class="o">-&gt;</span><span class="n">in</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">in</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">BUFFER_SIZE</span><span class="p">;</span>
  <span class="n">b</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
  
  <span class="n">cond_signal</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">not_empty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>  <span class="c1">// 通知有数据</span>
  <span class="n">lock_release</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">consumer</span> <span class="p">(</span><span class="k">struct</span> <span class="n">buffer</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">item</span><span class="p">;</span>
  <span class="n">lock_acquire</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
  
  <span class="k">while</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">cond_wait</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">not_empty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>  <span class="c1">// 等待有数据</span>
  
  <span class="n">item</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">items</span><span class="p">[</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">];</span>
  <span class="n">b</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">BUFFER_SIZE</span><span class="p">;</span>
  <span class="n">b</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
  
  <span class="n">cond_signal</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">not_full</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>   <span class="c1">// 通知有空位</span>
  <span class="n">lock_release</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
  
  <span class="k">return</span> <span class="n">item</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="cond_wait-的原子性"><span class="me-2">cond_wait 的原子性</span><a href="#cond_wait-的原子性" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kt">void</span>
<span class="nf">cond_wait</span> <span class="p">(</span><span class="k">struct</span> <span class="n">condition</span> <span class="o">*</span><span class="n">cond</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="n">list_push_back</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">waiters</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">waiter</span><span class="p">.</span><span class="n">elem</span><span class="p">);</span>
  <span class="n">lock_release</span> <span class="p">(</span><span class="n">lock</span><span class="p">);</span>            <span class="c1">// ← 这两步必须原子</span>
  <span class="n">sema_down</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">waiter</span><span class="p">.</span><span class="n">semaphore</span><span class="p">);</span>  <span class="c1">// ← 否则可能丢失信号</span>
  <span class="n">lock_acquire</span> <span class="p">(</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>问题场景</strong>（如果不是原子的）：</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>Thread A (等待者)              Thread B (通知者)
─────────────────────         ─────────────────────
lock_release(lock)
                              lock_acquire(lock)
                              change_condition()
                              cond_signal(...)  // 信号丢失！
                              lock_release(lock)
sema_down(...)  // 永远等待
</pre></td></tr></tbody></table></code></div></div>

<p><strong>为什么 Pintos 的实现是安全的？</strong></p>

<p>因为：</p>
<ol>
  <li><code class="language-plaintext highlighter-rouge">lock_release</code> 前，A 已经在等待队列中</li>
  <li><code class="language-plaintext highlighter-rouge">sema_down</code> 会阻塞，即使 <code class="language-plaintext highlighter-rouge">sema_up</code> 还没调用</li>
  <li>如果 B 在 A 的 <code class="language-plaintext highlighter-rouge">lock_release</code> 和 <code class="language-plaintext highlighter-rouge">sema_down</code> 之间调用 <code class="language-plaintext highlighter-rouge">cond_signal</code>，A 的信号量会被 up，<code class="language-plaintext highlighter-rouge">sema_down</code> 会立即返回</li>
</ol>

<hr />

<h2 id="条件变量状态图"><span class="me-2">条件变量状态图</span><a href="#条件变量状态图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre>                    cond_init()
                         │
                         ▼
                   ┌───────────┐
                   │ waiters=[]│
                   │   (空)    │
                   └───────────┘
                         │
                         │ Thread A: cond_wait
                         ▼
                   ┌───────────┐
                   │waiters=[A]│  A 的信号量值为 0
                   └───────────┘
                         │
          ┌──────────────┴──────────────┐
          │                             │
          │ Thread B: cond_wait         │ Thread C: cond_signal
          ▼                             ▼
   ┌───────────┐                 ┌───────────┐
   │waiters=   │                 │ waiters=[]│  A 被唤醒
   │  [A, B]   │                 └───────────┘
   └───────────┘
          │
          │ Thread C: cond_broadcast
          ▼
   ┌───────────┐
   │ waiters=[]│  A 和 B 都被唤醒
   └───────────┘
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="常见问题"><span class="me-2">常见问题</span><a href="#常见问题" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="q1-为什么-cond_wait-必须用-while-循环"><span class="me-2">Q1: 为什么 cond_wait 必须用 while 循环？</span><a href="#q1-为什么-cond_wait-必须用-while-循环" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>答</strong>：因为 Mesa 风格的管程中，被唤醒的线程不保证条件仍然为真：</p>

<ol>
  <li><strong>虚假唤醒</strong>：多个线程等待同一条件</li>
  <li><strong>竞争</strong>：从被唤醒到重新获取锁之间，条件可能又变了</li>
</ol>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="c1">// 错误</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">condition</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cond_wait</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// 可能条件仍然为假！</span>

<span class="c1">// 正确</span>
<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">condition</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cond_wait</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// 条件保证为真</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="q2-signal-和-broadcast-有什么区别"><span class="me-2">Q2: signal 和 broadcast 有什么区别？</span><a href="#q2-signal-和-broadcast-有什么区别" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>答</strong>：</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">signal</code>：唤醒一个等待者（效率高）</li>
  <li><code class="language-plaintext highlighter-rouge">broadcast</code>：唤醒所有等待者（更安全）</li>
</ul>

<p>使用 <code class="language-plaintext highlighter-rouge">broadcast</code> 的场景：</p>
<ul>
  <li>条件变化可能满足多个等待者</li>
  <li>不同等待者等待不同条件</li>
  <li>不确定哪个等待者应该被唤醒</li>
</ul>

<h3 id="q3-为什么条件变量必须和锁一起使用"><span class="me-2">Q3: 为什么条件变量必须和锁一起使用？</span><a href="#q3-为什么条件变量必须和锁一起使用" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>答</strong>：为了保护条件检查的原子性：</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="c1">// 没有锁 - 危险！</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">condition</span><span class="p">)</span> <span class="p">{</span>         <span class="c1">// 检查条件</span>
  <span class="c1">// 这里条件可能改变！</span>
  <span class="n">cond_wait</span> <span class="p">(...);</span>        <span class="c1">// 等待</span>
<span class="p">}</span>

<span class="c1">// 有锁 - 安全</span>
<span class="n">lock_acquire</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">condition</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cond_wait</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>  <span class="c1">// 原子地释放锁并等待</span>
<span class="p">}</span>
<span class="n">lock_release</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="q4-cond_signal-在无人等待时调用会怎样"><span class="me-2">Q4: cond_signal 在无人等待时调用会怎样？</span><a href="#q4-cond_signal-在无人等待时调用会怎样" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>答</strong>：什么都不会发生。信号会”丢失”。这与信号量不同（信号量会记住）。</p>

<h3 id="q5-为什么等待者队列存储-semaphore_elem-而不是直接存储线程"><span class="me-2">Q5: 为什么等待者队列存储 semaphore_elem 而不是直接存储线程？</span><a href="#q5-为什么等待者队列存储-semaphore_elem-而不是直接存储线程" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>答</strong>：每个等待者有自己的信号量，可以：</p>
<ol>
  <li>精确地唤醒特定等待者</li>
  <li>避免虚假唤醒问题</li>
  <li>简化实现</li>
</ol>

<hr />

<h2 id="调试技巧"><span class="me-2">调试技巧</span><a href="#调试技巧" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="打印等待队列"><span class="me-2">打印等待队列</span><a href="#打印等待队列" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="kt">void</span>
<span class="nf">debug_print_condition</span> <span class="p">(</span><span class="k">struct</span> <span class="n">condition</span> <span class="o">*</span><span class="n">cond</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">list_elem</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
  <span class="n">printf</span> <span class="p">(</span><span class="s">"Condition waiters: "</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">e</span> <span class="o">=</span> <span class="n">list_begin</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">waiters</span><span class="p">);</span> 
       <span class="n">e</span> <span class="o">!=</span> <span class="n">list_end</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">waiters</span><span class="p">);</span>
       <span class="n">e</span> <span class="o">=</span> <span class="n">list_next</span> <span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="k">struct</span> <span class="n">semaphore_elem</span> <span class="o">*</span><span class="n">se</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="k">struct</span> <span class="n">semaphore_elem</span><span class="p">,</span> <span class="n">elem</span><span class="p">);</span>
      <span class="c1">// 需要额外信息来识别等待者</span>
      <span class="n">printf</span> <span class="p">(</span><span class="s">"(sema) "</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="n">printf</span> <span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="检测死锁模式"><span class="me-2">检测死锁模式</span><a href="#检测死锁模式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kt">void</span>
<span class="nf">cond_wait</span> <span class="p">(</span><span class="k">struct</span> <span class="n">condition</span> <span class="o">*</span><span class="n">cond</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="n">printf</span> <span class="p">(</span><span class="s">"Thread '%s' waiting on condition</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">thread_current</span> <span class="p">()</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
  <span class="c1">// ... 原有代码 ...</span>
  <span class="n">printf</span> <span class="p">(</span><span class="s">"Thread '%s' woke up from condition</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">thread_current</span> <span class="p">()</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
  <span class="n">lock_acquire</span> <span class="p">(</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="练习思考"><span class="me-2">练习思考</span><a href="#练习思考" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<ol>
  <li>
    <p><strong>分析题</strong>：画出生产者-消费者示例中，一个生产者、两个消费者的执行序列。</p>
  </li>
  <li>
    <p><strong>设计题</strong>：如何实现一个带超时的 <code class="language-plaintext highlighter-rouge">cond_wait</code>？</p>
  </li>
  <li>
    <p><strong>编程题</strong>：使用条件变量实现一个读写锁（多个读者或一个写者）。</p>
  </li>
  <li>
    <p><strong>思考题</strong>：为什么 Pintos 选择 Mesa 风格而不是 Hoare 风格？</p>
  </li>
  <li>
    <p><strong>扩展题</strong>：研究 <code class="language-plaintext highlighter-rouge">pthread_cond_t</code> 的实现，与 Pintos 对比。</p>
  </li>
</ol>

<hr />

<h2 id="下一步"><span class="me-2">下一步</span><a href="#下一步" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>理解了条件变量后，下一篇文档将介绍<strong>中断处理</strong>与线程的关系，理解中断如何影响线程调度。</p>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/%E6%8A%80%E6%9C%AF/">技术</a>,
          <a href="/categories/pintos/">Pintos</a>
      </div>
    

    <!-- tags -->
    
      <div class="post-tags">
        <i class="fa fa-tags fa-fw me-1"></i>
        
          <a
            href="/tags/os/"
            class="post-tag no-text-decoration"
          >OS</a>
        
          <a
            href="/tags/pintos/"
            class="post-tag no-text-decoration"
          >Pintos</a>
        
          <a
            href="/tags/%E5%90%8C%E6%AD%A5/"
            class="post-tag no-text-decoration"
          >同步</a>
        
          <a
            href="/tags/%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F/"
            class="post-tag no-text-decoration"
          >条件变量</a>
        
      </div>
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          本文由作者按照 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         进行授权
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">分享</span>
  <span class="share-icons">
    
    
    

    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="分享链接"
      data-title-succeed="链接已复制！"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">最近更新</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pintos-thread-03-create/">Pintos 线程系统详解（三）：线程创建</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pintos-thread-04-schedule/">Pintos 线程系统详解（四）：线程调度</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pintos-thread-05-switch/">Pintos 线程系统详解（五）：上下文切换</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pintos-thread-06-block-unblock/">Pintos 线程系统详解（六）：阻塞与唤醒</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pintos-thread-07-semaphore/">Pintos 线程系统详解（七）：信号量</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">热门标签</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/os/">OS</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/pintos/">Pintos</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E6%B1%87%E7%BC%96/">汇编</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%BC%95%E5%AF%BC%E5%8A%A0%E8%BD%BD%E7%A8%8B%E5%BA%8F/">引导加载程序</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E7%BA%BF%E7%A8%8B/">线程</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%86%85%E6%A0%B8/">内核</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%90%8C%E6%AD%A5/">同步</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/c%E8%AF%AD%E8%A8%80/">C语言</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/gdt/">GDT</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/x86/">x86</a>
      
    </div>
  </section>


            </div>

            
              
              






  <div class="toc-border-cover z-3"></div>
  <section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4">
    <h2 class="panel-heading ps-3 pb-2 mb-0">文章内容</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->















  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">相关文章</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/pintos-thread-08-lock/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1769356800"
  data-df="YYYY/MM/DD"
  
>
  2026/01/26
</time>

              <h4 class="pt-0 my-2">Pintos 线程系统详解（八）：锁</h4>
              <div class="text-muted">
                <p>详细解析 Pintos 中锁（Lock）的实现，理解互斥机制。</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/pintos-thread-07-semaphore/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1769356800"
  data-df="YYYY/MM/DD"
  
>
  2026/01/26
</time>

              <h4 class="pt-0 my-2">Pintos 线程系统详解（七）：信号量</h4>
              <div class="text-muted">
                <p>详细解析 Pintos 中信号量（Semaphore）的实现，理解这一基础同步原语。</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/pintos-thread-06-block-unblock/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1769356800"
  data-df="YYYY/MM/DD"
  
>
  2026/01/26
</time>

              <h4 class="pt-0 my-2">Pintos 线程系统详解（六）：阻塞与唤醒</h4>
              <div class="text-muted">
                <p>详细解析 Pintos 中线程的阻塞与唤醒机制，包括 thread_block() 和 thread_unblock() 函数。</p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/pintos-thread-08-lock/"
      class="btn btn-outline-primary"
      aria-label="上一篇"
    >
      <p>Pintos 线程系统详解（八）：锁</p>
    </a>
  

  
    <a
      href="/posts/pintos-thread-10-interrupt/"
      class="btn btn-outline-primary"
      aria-label="下一篇"
    >
      <p>Pintos 线程系统详解（十）：中断处理</p>
    </a>
  
</nav>

            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>©
    <time>2026</time>

    
      <a href="https://github.com/zxsheather">Zxsheather</a>.
    

    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。"
      >保留部分权利。</span>
    
  </p>

  <p>本站采用 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 主题 <a
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="v7.4.1"
        href="https://github.com/cotes2020/jekyll-theme-chirpy"
        target="_blank"
        rel="noopener"
      >Chirpy</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center d-none">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">热门标签</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/os/">OS</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/pintos/">Pintos</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E6%B1%87%E7%BC%96/">汇编</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%BC%95%E5%AF%BC%E5%8A%A0%E8%BD%BD%E7%A8%8B%E5%BA%8F/">引导加载程序</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E7%BA%BF%E7%A8%8B/">线程</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%86%85%E6%A0%B8/">内核</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%90%8C%E6%AD%A5/">同步</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/c%E8%AF%AD%E8%A8%80/">C语言</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/gdt/">GDT</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/x86/">x86</a>
      
    </div>
  </section>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">发现新版本的内容。</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      更新
    </button>
  </div>
</aside>

    

    <!-- Embedded scripts -->

    
      
      <!-- The comments switcher -->


    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  
  document.addEventListener('DOMContentLoaded', () => {
    SimpleJekyllSearch({
      searchInput: document.getElementById('search-input'),
      resultsContainer: document.getElementById('search-results'),
      json: '/assets/js/data/search.json',
      searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{content}</p>  </article>',
      noResultsText: '<p class="mt-5">搜索结果为空</p>',
      templateMiddleware: function(prop, value, template) {
        if (prop === 'categories') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
          }
        }

        if (prop === 'tags') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
          }
        }
      }
    });
  });
</script>

  </body>
</html>

